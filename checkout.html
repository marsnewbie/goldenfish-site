<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Golden Fish</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Uber Eats Style Checkout - Single Page Design */
    .checkout-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      min-height: 100vh;
      background: #f6f6f6;
    }

    /* Header */
    .checkout-header {
      grid-column: 1 / -1;
      background: white;
      padding: 1rem 2rem;
      margin: -1rem -1rem 1rem -1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-section img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
    }

    .back-button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .back-button:hover {
      background-color: #f0f0f0;
    }

    /* Main Content Area */
    .checkout-main {
      background: white;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      height: fit-content;
    }

    /* Delivery Toggle - Uber Eats Style */
    .delivery-toggle-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .delivery-toggle {
      display: flex;
      background: #f6f6f6;
      border-radius: 8px;
      padding: 4px;
      position: relative;
    }

    .delivery-option {
      flex: 1;
      background: none;
      border: none;
      padding: 12px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      color: #666;
    }

    .delivery-option.active {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: #333;
    }

    .delivery-option:hover {
      color: #333;
    }

    /* Account Type Section */
    .account-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }

    .account-options {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .account-option {
      position: relative;
    }

    .account-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .account-option label {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .account-option input[type="radio"]:checked + label {
      border-color: #00d084;
      background: #f0fdf7;
    }

    .account-option .option-icon {
      font-size: 1.2rem;
    }

    .option-content {
      flex: 1;
    }

    .option-title {
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .option-desc {
      font-size: 0.85rem;
      color: #666;
    }

    /* Contact Information Section */
    .contact-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      position: relative;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #00d084;
    }

    .form-group input:invalid {
      border-color: #e74c3c;
    }

    .password-section {
      margin-top: 16px;
      display: none;
    }

    /* Sign In Section Styles */
    .signin-section {
      margin-top: 1rem;
      padding: 1.5rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #f8f9fa;
    }

    .signin-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
    }

    .signin-btn {
      padding: 12px 24px;
      background: #00d084;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .signin-btn:hover {
      background: #00b571;
    }

    .signin-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .forgot-password {
      color: #00d084;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .forgot-password:hover {
      text-decoration: underline;
    }

    .signin-status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
    }

    .signin-status.error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      display: block;
    }

    .signin-status.success {
      background: #efe;
      border: 1px solid #cfc;
      color: #3c3;
      display: block;
    }

    .signin-success {
      text-align: center;
      padding: 2rem;
    }

    .welcome-message {
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: center;
    }

    .success-icon {
      font-size: 2rem;
    }

    .welcome-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .welcome-subtitle {
      color: #666;
      font-size: 0.95rem;
    }

    .field-help {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }

    /* Address Section */
    .address-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      display: none;
    }

    .address-section h3 {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }

    /* Payment Section */
    .payment-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .payment-methods {
      display: grid;
      gap: 12px;
    }

    .payment-method {
      position: relative;
    }

    .payment-method input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .payment-method label {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-method input[type="radio"]:checked + label {
      border-color: #00d084;
      background: #f0fdf7;
    }

    .payment-icon {
      font-size: 1.5rem;
    }

    .payment-info {
      flex: 1;
    }

    .payment-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .payment-desc {
      font-size: 0.85rem;
      color: #666;
    }

    /* Special Instructions */
    .instructions-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    /* Order Summary Sidebar - Uber Eats Style */
    .order-summary {
      background: white;
      border-radius: 12px;
      height: fit-content;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 1rem;
    }

    .summary-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
    }

    .delivery-info {
      background: #f8f9fa;
      padding: 12px 16px;
      margin-top: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .delivery-time {
      font-weight: 600;
      color: #00d084;
    }

    /* Cart Items */
    .cart-items {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .item-options {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 4px;
    }

    .item-quantity {
      font-size: 0.85rem;
      color: #666;
    }

    .item-price {
      font-weight: 600;
    }

    .free-item .item-price {
      color: #00d084;
    }

    /* Order Totals */
    .order-totals {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .total-row.final {
      font-weight: 600;
      font-size: 1.1rem;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    /* Place Order Button */
    .place-order-section {
      padding: 1.5rem;
    }

    .place-order-btn {
      width: 100%;
      background: #00d084;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .place-order-btn:hover {
      background: #00b571;
    }

    .place-order-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .order-time-estimate {
      text-align: center;
      margin-top: 12px;
      font-size: 0.9rem;
      color: #666;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .checkout-container {
        grid-template-columns: 1fr;
        gap: 1rem;
        padding: 0.5rem;
      }

      .checkout-header {
        margin: -0.5rem -0.5rem 1rem -0.5rem;
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .account-options {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .order-summary {
        position: static;
      }
    }

    /* Error States */
    .error-message {
      color: #e74c3c;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .form-group.error input {
      border-color: #e74c3c;
    }

    /* Empty Cart State */
    .empty-cart {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .empty-cart-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <!-- Header -->
    <div class="checkout-header">
      <div class="header-content">
        <div class="logo-section">
          <button class="back-button" onclick="goBack()">‚Üê</button>
          <img src="assets/fish_and_chips.jpg" alt="Golden Fish">
          <span style="font-weight: 600;">Golden Fish</span>
        </div>
        <div>
          <span style="color: #666;">Checkout</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="checkout-main">
      <!-- Delivery Toggle -->
      <div class="delivery-toggle-section">
        <div class="delivery-toggle">
          <button class="delivery-option active" id="deliveryBtn" data-type="delivery">
            üöö Delivery
          </button>
          <button class="delivery-option" id="collectionBtn" data-type="collection">
            üì¶ Pickup
          </button>
        </div>
        <div id="deliveryInfo" class="delivery-info">
          <div class="delivery-time">25-35 min</div>
          <div>Delivered to your door</div>
        </div>
      </div>

      <!-- Account Type -->
      <div class="account-section">
        <div class="section-title">How would you like to checkout?</div>
        <div class="account-options">
          <div class="account-option">
            <input type="radio" name="accountType" value="guest" id="guestCheckout" checked>
            <label for="guestCheckout">
              <div class="option-icon">üë§</div>
              <div class="option-content">
                <div class="option-title">Guest</div>
                <div class="option-desc">Quick checkout</div>
              </div>
            </label>
          </div>
          
          <div class="account-option">
            <input type="radio" name="accountType" value="signin" id="signinCheckout">
            <label for="signinCheckout">
              <div class="option-icon">üîë</div>
              <div class="option-content">
                <div class="option-title">Sign In</div>
                <div class="option-desc">Access your account</div>
              </div>
            </label>
          </div>
          
          <div class="account-option">
            <input type="radio" name="accountType" value="register" id="registerCheckout">
            <label for="registerCheckout">
              <div class="option-icon">üîê</div>
              <div class="option-content">
                <div class="option-title">Create Account</div>
                <div class="option-desc">Save for next time</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="contact-section">
        <div class="section-title">Contact Information</div>
        <div class="form-grid">
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <input type="text" id="firstName" name="firstName" required>
          </div>
          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <input type="text" id="lastName" name="lastName" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input type="tel" id="phone" name="phone" placeholder="07123 456789" required>
          </div>
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" name="email" required>
          </div>
        </div>

        <!-- Password for registered users -->
        <div class="password-section" id="passwordSection">
          <div class="form-group">
            <label for="password">Create Password *</label>
            <input type="password" id="password" name="password" minlength="6">
            <div class="field-help">Minimum 6 characters</div>
          </div>
        </div>

        <!-- Sign In section for existing users -->
        <div class="signin-section" id="signinSection" style="display: none;">
          <div class="signin-form">
            <div class="form-group">
              <label for="signinEmail">Email Address *</label>
              <input type="email" id="signinEmail" name="signinEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
              <label for="signinPassword">Password *</label>
              <input type="password" id="signinPassword" name="signinPassword" placeholder="Enter your password">
            </div>
            <div class="signin-actions">
              <button type="button" class="signin-btn" id="signinBtn">Sign In</button>
              <a href="#" class="forgot-password">Forgot Password?</a>
            </div>
            <div class="signin-status" id="signinStatus"></div>
          </div>
          
          <!-- Success state after signin -->
          <div class="signin-success" id="signinSuccess" style="display: none;">
            <div class="welcome-message">
              <div class="success-icon">‚úÖ</div>
              <div class="welcome-text">
                <div class="welcome-title">Welcome back!</div>
                <div class="welcome-subtitle" id="welcomeUserName"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery Address -->
        <div class="address-section" id="addressSection">
          <h3>Delivery Address</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="street">Street Address *</label>
              <input type="text" id="street" name="street" placeholder="123 Main Street">
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="city">City *</label>
              <input type="text" id="city" name="city" value="York">
            </div>
            <div class="form-group">
              <label for="postcode">Postcode *</label>
              <input type="text" id="postcode" name="postcode" placeholder="YO10 3BP">
            </div>
          </div>
          <div class="form-group">
            <label for="deliveryNotes">Delivery Instructions (Optional)</label>
            <textarea id="deliveryNotes" name="deliveryNotes" placeholder="e.g., Ring doorbell, leave at door" rows="2"></textarea>
          </div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="payment-section">
        <div class="section-title">Payment Method</div>
        <div class="payment-methods">
          <div class="payment-method">
            <input type="radio" name="paymentMethod" value="card" id="cardPayment" checked>
            <label for="cardPayment">
              <div class="payment-icon">üí≥</div>
              <div class="payment-info">
                <div class="payment-title">Credit/Debit Card</div>
                <div class="payment-desc">Visa, Mastercard, American Express</div>
              </div>
            </label>
          </div>
          
          <div class="payment-method">
            <input type="radio" name="paymentMethod" value="cash" id="cashPayment">
            <label for="cashPayment">
              <div class="payment-icon">üíµ</div>
              <div class="payment-info">
                <div class="payment-title">Cash on Delivery</div>
                <div class="payment-desc">Pay when your order arrives</div>
              </div>
            </label>
          </div>

          <div class="payment-method">
            <input type="radio" name="paymentMethod" value="paypal" id="paypalPayment">
            <label for="paypalPayment">
              <div class="payment-icon">üÖøÔ∏è</div>
              <div class="payment-info">
                <div class="payment-title">PayPal</div>
                <div class="payment-desc">Pay with your PayPal account</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Special Instructions -->
      <div class="instructions-section">
        <div class="section-title">Special Instructions</div>
        <div class="form-group">
          <textarea id="specialInstructions" name="specialInstructions" placeholder="Any special requests for your order..." rows="3"></textarea>
        </div>
      </div>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="order-summary">
      <div class="summary-header">
        <div class="summary-title">Your Order</div>
        <div id="deliveryInfoSummary" class="delivery-info">
          <div class="delivery-time">25-35 min</div>
          <div>Delivery to YO10 3BP</div>
        </div>
      </div>

      <div class="cart-items" id="cartItems">
        <div class="empty-cart">
          <div class="empty-cart-icon">üçΩÔ∏è</div>
          <p>Your cart is empty</p>
          <p>Add items from the menu</p>
        </div>
      </div>

      <div class="order-totals" id="orderTotals" style="display: none;">
        <div class="total-row">
          <span>Subtotal</span>
          <span id="subtotal">¬£0.00</span>
        </div>
        <div class="total-row" id="deliveryFeeRow" style="display: none;">
          <span>Delivery Fee</span>
          <span id="deliveryFee">¬£0.00</span>
        </div>
        <div class="total-row" id="discountRow" style="display: none;">
          <span>Discount</span>
          <span id="discount">-¬£0.00</span>
        </div>
        <div class="total-row final">
          <span>Total</span>
          <span id="total">¬£0.00</span>
        </div>
      </div>

      <div class="place-order-section">
        <button class="place-order-btn" id="placeOrderBtn" disabled>
          Add items to place order
        </button>
        <div class="order-time-estimate" id="timeEstimate">
          Estimated delivery: 25-35 minutes
        </div>
      </div>
    </div>
  </div>

  <script>
    class UberEatsCheckout {
      constructor() {
        this.orderData = {
          items: [],
          deliveryType: 'delivery',
          deliveryAddress: null,
          postcode: null,
          deliveryFee: null,
          contact: {},
          paymentMethod: 'card',
          specialInstructions: '',
          appliedPromotions: [],
          totals: {
            subtotal: 0,
            discount: 0,
            deliveryFee: 0,
            total: 0
          }
        };
        
        this.init();
      }

      // Initialize authentication mode from URL parameters
      initializeAuthFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const authMode = urlParams.get('auth');
        
        console.log('üîó URL auth parameter:', authMode);
        
        if (authMode && ['guest', 'signin', 'register'].includes(authMode)) {
          // Select the appropriate radio button
          const targetRadio = document.querySelector(`input[name="accountType"][value="${authMode}"]`);
          if (targetRadio) {
            // Uncheck all radio buttons first
            document.querySelectorAll('input[name="accountType"]').forEach(radio => {
              radio.checked = false;
            });
            // Check the target radio button
            targetRadio.checked = true;
            console.log(`‚úÖ Pre-selected ${authMode} mode from URL`);
          }
        }
      }

      init() {
        this.loadOrderData();
        this.setupEventHandlers();
        this.renderCart();
        this.updateDeliveryDisplay();
        
        // Initialize authentication sections
        this.initializeAuthFromURL();
        const defaultAccountType = document.querySelector('input[name="accountType"]:checked').value;
        this.toggleAuthSections(defaultAccountType);
      }

      loadOrderData() {
        // Load cart from localStorage
        try {
          const storedCart = localStorage.getItem('goldenfish_cart');
          if (storedCart) {
            this.orderData.items = JSON.parse(storedCart);
          }

          // Load delivery type
          const deliveryType = localStorage.getItem('goldenfish_order_type');
          if (deliveryType) {
            this.orderData.deliveryType = deliveryType;
            this.updateDeliveryToggle();
          }

          // Load applied promotions
          const appliedPromotions = localStorage.getItem('goldenfish_applied_promotions');
          if (appliedPromotions) {
            try {
              this.orderData.appliedPromotions = JSON.parse(appliedPromotions);
            } catch (e) {
              console.log('Error parsing applied promotions');
              this.orderData.appliedPromotions = [];
            }
          } else {
            this.orderData.appliedPromotions = [];
          }

          // Load postcode and delivery fee
          const postcode = localStorage.getItem('goldenfish_postcode');
          const deliveryFeeData = localStorage.getItem('goldenfish_delivery_fee');
          
          if (postcode) {
            this.orderData.postcode = postcode;
            document.getElementById('postcode').value = postcode;
          }

          if (deliveryFeeData) {
            try {
              this.orderData.deliveryFee = JSON.parse(deliveryFeeData);
            } catch (e) {
              console.log('Error parsing delivery fee data');
            }
          }
        } catch (error) {
          console.log('Error loading order data:', error);
        }
      }

      setupEventHandlers() {
        // Delivery toggle
        const deliveryToggle = document.querySelectorAll('.delivery-option');
        deliveryToggle.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const type = e.target.dataset.type;
            this.setDeliveryType(type);
          });
        });

        // Account type toggle
        const accountTypes = document.querySelectorAll('input[name="accountType"]');
        accountTypes.forEach(radio => {
          radio.addEventListener('change', (e) => {
            this.toggleAuthSections(e.target.value);
          });
        });

        // Sign In button
        const signinBtn = document.getElementById('signinBtn');
        signinBtn.addEventListener('click', () => this.handleSignIn());

        // Form validation
        const requiredInputs = document.querySelectorAll('input[required], textarea[required]');
        requiredInputs.forEach(input => {
          input.addEventListener('blur', () => this.validateField(input));
          input.addEventListener('input', () => this.validateField(input));
        });

        // Phone number formatting
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', (e) => {
          this.formatPhoneNumber(e.target);
        });

        // Postcode validation
        const postcodeInput = document.getElementById('postcode');
        postcodeInput.addEventListener('blur', () => {
          if (postcodeInput.value.trim()) {
            this.validatePostcode(postcodeInput.value.trim());
          }
        });

        // Place order button
        document.getElementById('placeOrderBtn').addEventListener('click', () => {
          this.placeOrder();
        });

        // Form change listener for validation
        document.addEventListener('input', () => {
          this.updatePlaceOrderButton();
        });
      }

      setDeliveryType(type) {
        this.orderData.deliveryType = type;
        
        // Update toggle buttons
        document.querySelectorAll('.delivery-option').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-type="${type}"]`).classList.add('active');
        
        // Show/hide address section
        const addressSection = document.getElementById('addressSection');
        if (type === 'delivery') {
          addressSection.style.display = 'block';
        } else {
          addressSection.style.display = 'none';
        }

        this.updateDeliveryDisplay();
        this.calculateTotals();
      }

      updateDeliveryToggle() {
        // Set active button
        document.querySelectorAll('.delivery-option').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-type="${this.orderData.deliveryType}"]`).classList.add('active');
        
        // Show/hide address section
        const addressSection = document.getElementById('addressSection');
        addressSection.style.display = this.orderData.deliveryType === 'delivery' ? 'block' : 'none';
      }

      toggleAuthSections(accountType) {
        console.log('üîÑ toggleAuthSections called with:', accountType);
        
        const passwordSection = document.getElementById('passwordSection');
        const signinSection = document.getElementById('signinSection');
        const contactSection = document.querySelector('.contact-section');
        const passwordInput = document.getElementById('password');
        
        console.log('üìã Elements found:', {
          passwordSection: !!passwordSection,
          signinSection: !!signinSection, 
          contactSection: !!contactSection,
          passwordInput: !!passwordInput
        });
        
        // Hide all auth-specific sections first
        passwordSection.style.display = 'none';
        signinSection.style.display = 'none';
        passwordInput.removeAttribute('required');
        
        // Show contact form for guest and register
        contactSection.style.display = (accountType === 'signin') ? 'none' : 'block';
        
        switch(accountType) {
          case 'guest':
            console.log('‚úÖ Showing guest mode (contact form only)');
            // Guest: Only show contact form (already visible)
            break;
            
          case 'register':
            console.log('‚úÖ Showing register mode (contact form + password)');
            // Register: Show contact form + password section
            passwordSection.style.display = 'block';
            passwordInput.setAttribute('required', '');
            break;
            
          case 'signin':
            console.log('‚úÖ Showing signin mode (signin form only)');
            // Sign In: Show sign in form, hide contact form
            signinSection.style.display = 'block';
            break;
        }
      }

      async handleSignIn() {
        const email = document.getElementById('signinEmail').value.trim();
        const password = document.getElementById('signinPassword').value;
        const signinBtn = document.getElementById('signinBtn');
        const signinStatus = document.getElementById('signinStatus');
        
        // Basic validation
        if (!email || !password) {
          this.showSignInStatus('Please enter both email and password.', 'error');
          return;
        }
        
        // Show loading state
        signinBtn.disabled = true;
        signinBtn.textContent = 'Signing In...';
        signinStatus.className = 'signin-status';
        signinStatus.style.display = 'none';
        
        try {
          // Call backend API for authentication
          console.log('üîê Attempting sign in for:', email);
          
          const response = await fetch('https://goldenfish-backend-production.up.railway.app/api/auth/signin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
          });
          
          if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Sign in successful:', result);
            
            // Show success and populate user data
            this.handleSignInSuccess(result.user);
            
          } else {
            const error = await response.json().catch(() => ({ message: 'Sign in failed' }));
            this.showSignInStatus(error.message || 'Invalid email or password.', 'error');
          }
          
        } catch (error) {
          console.error('‚ùå Sign in error:', error);
          this.showSignInStatus('Unable to connect to authentication service. Please try again.', 'error');
        } finally {
          // Reset button state
          signinBtn.disabled = false;
          signinBtn.textContent = 'Sign In';
        }
      }
      
      showSignInStatus(message, type) {
        const signinStatus = document.getElementById('signinStatus');
        signinStatus.textContent = message;
        signinStatus.className = `signin-status ${type}`;
        signinStatus.style.display = 'block';
      }
      
      handleSignInSuccess(user) {
        // Hide sign in form, show success message
        const signinForm = document.querySelector('.signin-form');
        const signinSuccess = document.getElementById('signinSuccess');
        const welcomeUserName = document.getElementById('welcomeUserName');
        
        signinForm.style.display = 'none';
        welcomeUserName.textContent = `${user.firstName} ${user.lastName} ‚Ä¢ ${user.email}`;
        signinSuccess.style.display = 'block';
        
        // Store user session data
        this.orderData.user = user;
        this.orderData.contact = {
          firstName: user.firstName,
          lastName: user.lastName,
          email: user.email,
          phone: user.phone,
          accountType: 'signin'
        };
        
        // Auto-populate delivery address if user has a saved address
        if (user.savedAddresses && user.savedAddresses.length > 0) {
          const defaultAddress = user.savedAddresses.find(addr => addr.isDefault) || user.savedAddresses[0];
          if (defaultAddress) {
            document.getElementById('street').value = defaultAddress.street;
            document.getElementById('city').value = defaultAddress.city;
            document.getElementById('postcode').value = defaultAddress.postcode;
          }
        }
        
        console.log('‚úÖ User signed in successfully:', user.firstName, user.lastName);
      }

      formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.startsWith('44')) {
          value = '+' + value;
        } else if (value.startsWith('0')) {
          // UK format
        } else if (value.length === 10) {
          value = '0' + value;
        }
        input.value = value;
      }

      async validatePostcode(postcode) {
        const normalizedPostcode = this.normalizePostcode(postcode);
        if (!normalizedPostcode) return false;

        try {
          const response = await fetch(`https://api.postcodes.io/postcodes/${normalizedPostcode}`);
          const data = await response.json();
          
          if (data.status === 200) {
            // Valid postcode, calculate delivery fee
            await this.calculateDeliveryFee(normalizedPostcode);
            return true;
          }
        } catch (error) {
          console.log('Postcode validation error:', error);
        }
        return false;
      }

      normalizePostcode(postcode) {
        const cleaned = postcode.trim().toUpperCase().replace(/\s/g, '');
        if (cleaned.length < 5) return null;
        return cleaned.slice(0, -3) + ' ' + cleaned.slice(-3);
      }

      async calculateDeliveryFee(postcode) {
        // Mock delivery fee calculation based on postcode
        const postcodePrefix = postcode.split(' ')[0];
        let fee = 2.50; // Default fee

        // Example pricing zones
        if (postcodePrefix === 'YO10') {
          fee = 2.50;
        } else if (postcodePrefix === 'YO11') {
          fee = 3.00;
        } else if (postcodePrefix === 'YO12') {
          fee = 3.50;
        }

        this.orderData.deliveryFee = {
          valid: true,
          fee: fee,
          zone: postcodePrefix
        };

        this.calculateTotals();
      }

      validateField(field) {
        const value = field.value.trim();
        const fieldGroup = field.closest('.form-group');
        
        // Remove existing error states
        fieldGroup.classList.remove('error');
        const existingError = fieldGroup.querySelector('.error-message');
        if (existingError) existingError.remove();

        let isValid = true;
        let errorMessage = '';

        // Required field validation
        if (field.hasAttribute('required') && !value) {
          isValid = false;
          errorMessage = 'This field is required';
        }

        // Email validation
        if (field.type === 'email' && value) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid email address';
          }
        }

        // Phone validation (UK)
        if (field.name === 'phone' && value) {
          const ukPhoneRegex = /^(\+44\s?|0)([1-9]\d{8,9})$/;
          if (!ukPhoneRegex.test(value.replace(/\s/g, ''))) {
            isValid = false;
            errorMessage = 'Please enter a valid UK phone number';
          }
        }

        // Password validation
        if (field.type === 'password' && value && value.length < 6) {
          isValid = false;
          errorMessage = 'Password must be at least 6 characters';
        }

        if (!isValid) {
          fieldGroup.classList.add('error');
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = errorMessage;
          fieldGroup.appendChild(errorDiv);
        }

        return isValid;
      }

      calculateTotals() {
        let subtotal = 0;
        let totalDiscount = 0;

        this.orderData.items.forEach(item => {
          let itemPrice = item.price;
          
          // Add options pricing
          if (item.selectedOptions) {
            Object.values(item.selectedOptions).forEach(option => {
              if (Array.isArray(option)) {
                option.forEach(opt => itemPrice += opt.price || 0);
              } else {
                itemPrice += option.price || 0;
              }
            });
          }

          const lineTotal = itemPrice * item.qty;
          
          if (item.isFreeItem) {
            totalDiscount += lineTotal;
          } else {
            subtotal += lineTotal;
          }
        });

        // Apply promotions from localStorage
        let totalPromotionDiscount = 0;
        if (this.orderData.appliedPromotions && this.orderData.appliedPromotions.length > 0) {
          this.orderData.appliedPromotions.forEach(promotion => {
            totalPromotionDiscount += promotion.discountAmount || 0;
          });
        }

        let deliveryFee = 0;
        if (this.orderData.deliveryType === 'delivery' && this.orderData.deliveryFee?.valid) {
          deliveryFee = this.orderData.deliveryFee.fee || 0;
        }

        this.orderData.totals = {
          subtotal: subtotal,
          discount: totalDiscount + totalPromotionDiscount,
          deliveryFee: deliveryFee,
          total: Math.max(0, subtotal - totalDiscount - totalPromotionDiscount + deliveryFee)
        };

        this.updateTotalsDisplay();
      }

      renderCart() {
        const cartContainer = document.getElementById('cartItems');
        const totalsContainer = document.getElementById('orderTotals');

        if (this.orderData.items.length === 0) {
          cartContainer.innerHTML = `
            <div class="empty-cart">
              <div class="empty-cart-icon">üçΩÔ∏è</div>
              <p>Your cart is empty</p>
              <p><a href="menu.html" style="color: #00d084;">Add items from menu</a></p>
            </div>
          `;
          totalsContainer.style.display = 'none';
          return;
        }

        let html = '';
        this.orderData.items.forEach(item => {
          let itemPrice = item.price;
          let optionsText = '';

          if (item.selectedOptions) {
            Object.values(item.selectedOptions).forEach(option => {
              if (Array.isArray(option)) {
                option.forEach(opt => itemPrice += opt.price || 0);
              } else {
                itemPrice += option.price || 0;
              }
            });

            optionsText = Object.entries(item.selectedOptions)
              .map(([group, choice]) => {
                if (Array.isArray(choice)) {
                  return choice.map(c => c.name).join(', ');
                }
                return choice.name;
              })
              .join(' ‚Ä¢ ');
          }

          const lineTotal = itemPrice * item.qty;

          html += `
            <div class="cart-item ${item.isFreeItem ? 'free-item' : ''}">
              <div class="item-details">
                <div class="item-name">${item.name} ${item.isFreeItem ? '(FREE)' : ''}</div>
                ${optionsText ? `<div class="item-options">${optionsText}</div>` : ''}
                <div class="item-quantity">Qty: ${item.qty}</div>
              </div>
              <div class="item-price">¬£${lineTotal.toFixed(2)}</div>
            </div>
          `;
        });

        cartContainer.innerHTML = html;
        totalsContainer.style.display = 'block';
        this.calculateTotals();
      }

      updateTotalsDisplay() {
        document.getElementById('subtotal').textContent = `¬£${this.orderData.totals.subtotal.toFixed(2)}`;
        
        const deliveryRow = document.getElementById('deliveryFeeRow');
        if (this.orderData.totals.deliveryFee > 0) {
          deliveryRow.style.display = 'flex';
          document.getElementById('deliveryFee').textContent = `¬£${this.orderData.totals.deliveryFee.toFixed(2)}`;
        } else {
          deliveryRow.style.display = 'none';
        }

        const discountRow = document.getElementById('discountRow');
        if (this.orderData.totals.discount > 0) {
          discountRow.style.display = 'flex';
          document.getElementById('discount').textContent = `-¬£${this.orderData.totals.discount.toFixed(2)}`;
        } else {
          discountRow.style.display = 'none';
        }

        document.getElementById('total').textContent = `¬£${this.orderData.totals.total.toFixed(2)}`;
        
        this.updatePlaceOrderButton();
      }

      updateDeliveryDisplay() {
        const deliveryInfo = document.getElementById('deliveryInfo');
        const summarySide = document.getElementById('deliveryInfoSummary');
        const timeEstimate = document.getElementById('timeEstimate');

        if (this.orderData.deliveryType === 'delivery') {
          deliveryInfo.innerHTML = `
            <div class="delivery-time">25-35 min</div>
            <div>Delivered to your door</div>
          `;
          summarySide.innerHTML = `
            <div class="delivery-time">25-35 min</div>
            <div>Delivery ${this.orderData.postcode ? 'to ' + this.orderData.postcode : ''}</div>
          `;
          timeEstimate.textContent = 'Estimated delivery: 25-35 minutes';
        } else {
          deliveryInfo.innerHTML = `
            <div class="delivery-time">15-20 min</div>
            <div>Ready for collection</div>
          `;
          summarySide.innerHTML = `
            <div class="delivery-time">15-20 min</div>
            <div>Ready for pickup</div>
          `;
          timeEstimate.textContent = 'Ready for pickup in 15-20 minutes';
        }
      }

      updatePlaceOrderButton() {
        const btn = document.getElementById('placeOrderBtn');
        
        if (this.orderData.items.length === 0) {
          btn.disabled = true;
          btn.textContent = 'Add items to place order';
          return;
        }

        // Check required fields
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        
        let addressValid = true;
        if (this.orderData.deliveryType === 'delivery') {
          const street = document.getElementById('street').value.trim();
          const city = document.getElementById('city').value.trim();
          const postcode = document.getElementById('postcode').value.trim();
          addressValid = street && city && postcode;
        }

        const accountType = document.querySelector('input[name="accountType"]:checked').value;
        let passwordValid = true;
        if (accountType === 'register') {
          const password = document.getElementById('password').value;
          passwordValid = password && password.length >= 6;
        }

        if (firstName && lastName && phone && email && addressValid && passwordValid) {
          btn.disabled = false;
          btn.textContent = `Place order ‚Ä¢ ¬£${this.orderData.totals.total.toFixed(2)}`;
        } else {
          btn.disabled = true;
          btn.textContent = 'Complete all required fields';
        }
      }

      async placeOrder() {
        // Validate all fields
        if (!this.validateAllFields()) {
          alert('Please complete all required fields correctly.');
          return;
        }

        // Collect order data
        this.collectOrderData();

        try {
          // Show loading state
          const btn = document.getElementById('placeOrderBtn');
          btn.disabled = true;
          btn.textContent = 'Placing your order...';

          // Submit order to backend API
          await this.submitOrderToAPI();
          
          // Clear cart and redirect
          localStorage.removeItem('goldenfish_cart');
          localStorage.removeItem('goldenfish_applied_promotions');
          localStorage.removeItem('goldenfish_order_type');
          localStorage.removeItem('goldenfish_postcode');
          localStorage.removeItem('goldenfish_delivery_fee');
          window.location.href = 'index.html';

        } catch (error) {
          console.error('Order placement error:', error);
          alert('There was an error placing your order. Please try again.');
          
          // Reset button
          const btn = document.getElementById('placeOrderBtn');
          btn.disabled = false;
          btn.textContent = `Place order ‚Ä¢ ¬£${this.orderData.totals.total.toFixed(2)}`;
        }
      }

      validateAllFields() {
        const requiredFields = document.querySelectorAll('input[required], textarea[required]');
        let allValid = true;

        requiredFields.forEach(field => {
          if (!this.validateField(field)) {
            allValid = false;
          }
        });

        return allValid;
      }

      collectOrderData() {
        const accountType = document.querySelector('input[name="accountType"]:checked').value;
        
        if (accountType === 'signin' && this.orderData.contact) {
          // User is signed in, use stored contact data
          console.log('üîë Using signed-in user data');
        } else {
          // Guest or register - collect from form
          this.orderData.contact = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            accountType: accountType
          };
        }
        
        // Add password for registration
        if (accountType === 'register') {
          this.orderData.contact.password = document.getElementById('password').value;
        }

        if (this.orderData.deliveryType === 'delivery') {
          this.orderData.deliveryAddress = {
            street: document.getElementById('street').value.trim(),
            city: document.getElementById('city').value.trim(),
            postcode: document.getElementById('postcode').value.trim(),
            instructions: document.getElementById('deliveryNotes').value.trim()
          };
        }

        this.orderData.paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        this.orderData.specialInstructions = document.getElementById('specialInstructions').value.trim();

        console.log('Order data:', this.orderData);
      }

      generateOrderNumber() {
        // Option 1: Date-based with daily counter (YYMMDD-XXX)
        // Option 2: Long random ID for security
        
        const useRandomId = false; // Set to true for long random IDs
        
        if (useRandomId) {
          // Generate long random order ID (16 chars)
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let result = 'GF-';
          for (let i = 0; i < 12; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          return result;
        } else {
          // Date-based with daily counter
          const now = new Date();
          const dateStr = now.getFullYear().toString().slice(-2) + 
                         (now.getMonth() + 1).toString().padStart(2, '0') + 
                         now.getDate().toString().padStart(2, '0');
          
          // Get or create daily counter
          const counterKey = `gf_daily_counter_${dateStr}`;
          let dailyCounter = parseInt(localStorage.getItem(counterKey) || '0');
          dailyCounter += 1;
          
          // Store updated counter
          localStorage.setItem(counterKey, dailyCounter.toString());
          
          // Clean up old counters (keep only last 30 days)
          this.cleanupOldCounters();
          
          return `GF${dateStr}-${dailyCounter.toString().padStart(3, '0')}`;
        }
      }

      cleanupOldCounters() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        // Check localStorage for old counters and remove them
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('gf_daily_counter_')) {
            const dateStr = key.replace('gf_daily_counter_', '');
            if (dateStr.length === 6) {
              const year = 2000 + parseInt(dateStr.slice(0, 2));
              const month = parseInt(dateStr.slice(2, 4)) - 1;
              const day = parseInt(dateStr.slice(4, 6));
              const counterDate = new Date(year, month, day);
              
              if (counterDate < thirtyDaysAgo) {
                localStorage.removeItem(key);
              }
            }
          }
        });
      }

      async submitOrderToAPI() {
        const customerName = `${this.orderData.contact.firstName} ${this.orderData.contact.lastName}`;
        
        console.log('üöÄ Submitting order to backend API...');
        
        // Prepare order data for API (format for backend compatibility)
        const orderData = {
          customerInfo: {
            firstName: this.orderData.contact.firstName,
            lastName: this.orderData.contact.lastName,
            email: this.orderData.contact.email,
            phone: this.orderData.contact.phone,
            accountType: this.orderData.contact.accountType || 'guest',
            password: this.orderData.contact.password
          },
          // Convert items array - change 'quantity' to 'qty' for backend compatibility
          items: this.orderData.items.map(item => ({
            name: item.name,
            price: item.price,
            qty: item.quantity || item.qty, // Support both formats
            selectedOptions: item.selectedOptions,
            isFreeItem: item.isFreeItem || false
          })),
          deliveryType: this.orderData.deliveryType,
          // Format delivery address for backend compatibility
          deliveryAddress: this.orderData.deliveryType === 'delivery' ? {
            street: this.orderData.deliveryAddress?.address || document.getElementById('address').value,
            city: 'York', // Default city for now
            postcode: this.orderData.postcode || document.getElementById('postcode').value,
            instructions: this.orderData.deliveryAddress?.instructions || document.getElementById('deliveryInstructions')?.value || ''
          } : undefined,
          specialInstructions: this.orderData.specialInstructions || undefined, // Don't send empty string
          paymentMethod: this.orderData.paymentMethod || 'card',
          totals: this.orderData.totals
        };

        console.log('üì§ Order data:', orderData);

        try {
          // Use Railway production API only (localhost fallback removed for production)
          const apiUrls = [
            'https://goldenfish-backend-production.up.railway.app/api/orders' // Railway production
          ];
          
          let response;
          let lastError;
          
          for (const apiUrl of apiUrls) {
            try {
              console.log(`üîÑ Trying API endpoint: ${apiUrl}`);
              console.log(`üì§ Request payload:`, JSON.stringify(orderData, null, 2));
              
              response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
              });
              
              console.log(`üì• Response status: ${response.status} ${response.statusText}`);
              
              if (response.ok) {
                // Success! Break out of the loop to continue with success handling
                break;
              } else {
                const errorText = await response.text();
                console.error(`‚ùå Failed with ${apiUrl}:`, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
              }
            } catch (error) {
              console.error(`‚ùå Failed with ${apiUrl}:`, error.message);
              lastError = error;
              response = null;
            }
          }
          
          if (!response || !response.ok) {
            throw lastError || new Error('All API endpoints failed');
          }

          const result = await response.json();
          console.log('‚úÖ Order submitted successfully:', result);

          if (result.success && result.data) {
            // Store order details
            this.orderData.orderNumber = result.data.orderNumber;
            
            // Show success message
            const emailStatus = result.data.emailSent ? 
              `\n‚úÖ Confirmation email sent to: ${this.orderData.contact.email}` :
              `\n‚ö†Ô∏è Order confirmed but email delivery failed.`;
            
            alert(`üéâ Order placed successfully!\n\nOrder Number: ${result.data.orderNumber}\nEstimated Time: ${result.data.estimatedTime} minutes${emailStatus}`);
            
            return result.data;
          } else {
            throw new Error(result.message || 'Invalid API response');
          }

        } catch (error) {
          console.error('‚ùå Order submission failed:', error);
          
          // Fallback: Generate local order number and continue
          const fallbackOrderNumber = this.generateOrderNumber();
          
          alert(`‚ùå Unable to connect to our ordering system.\n\nYour order details have been saved locally:\nOrder Number: ${fallbackOrderNumber}\n\nPlease call us at 01904 123456 to complete your order.\n\nWe apologize for the inconvenience!`);
          
          // Store fallback order number
          this.orderData.orderNumber = fallbackOrderNumber;
          
          return {
            orderNumber: fallbackOrderNumber,
            emailSent: false,
            estimatedTime: this.orderData.deliveryType === 'delivery' ? 30 : 20
          };
        }
      }
    }

    // Initialize checkout
    let checkout;
    document.addEventListener('DOMContentLoaded', () => {
      checkout = new UberEatsCheckout();
    });

    // Helper functions
    function goBack() {
      window.location.href = 'menu.html';
    }
  </script>
</body>
</html>