<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Golden Fish Restaurant</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        @media (max-width: 968px) {
            .checkout-container {
                grid-template-columns: 1fr;
                max-width: 600px;
            }
        }

        .checkout-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .checkout-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .emoji {
            font-size: 24px;
        }

        /* Header */
        .checkout-header {
            background: white;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-button {
            background: #f3f4f6;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .logo-section img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        /* Authentication Section */
        .auth-choice {
            display: grid;
            gap: 16px;
        }

        .auth-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .auth-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .auth-option input[type="radio"] {
            margin: 0;
        }

        .auth-content h3 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .auth-content p {
            font-size: 14px;
            color: #6b7280;
        }

        /* Forms */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            margin-top: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 500;
            color: #374151;
        }

        .required {
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input.error,
        .form-group select.error {
            border-color: #ef4444;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 4px;
        }

        /* Delivery options */
        .delivery-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .delivery-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delivery-option:hover {
            border-color: #3b82f6;
        }

        .delivery-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Address validation */
        .postcode-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
        }

        .postcode-status.valid {
            color: #16a34a;
        }

        .postcode-status.invalid {
            color: #ef4444;
        }

        /* Payment methods */
        .payment-methods {
            display: grid;
            gap: 12px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: #3b82f6;
        }

        .payment-method.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .btn-success:hover:not(:disabled) {
            background: #16a34a;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Order Summary Sidebar */
        .order-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .order-summary {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-details h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .item-details .options {
            font-size: 14px;
            color: #6b7280;
        }

        .item-price {
            font-weight: 600;
            color: #1f2937;
        }

        .order-totals {
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .total-row.final {
            font-weight: 600;
            font-size: 18px;
            color: #1f2937;
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
            margin-top: 12px;
        }

        /* Status messages */
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* Terms and conditions */
        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 16px 0;
            font-size: 14px;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 2px;
        }

        .terms-checkbox a {
            color: #3b82f6;
            text-decoration: none;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        /* Loading states */
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="checkout-header">
        <div class="header-content">
            <div class="logo-section">
                <button class="back-button" onclick="window.history.back()">← Back</button>
                <img src="assets/fish_and_chips.jpg" alt="Golden Fish">
                <span style="font-weight: 600; font-size: 18px;">Golden Fish Checkout</span>
            </div>
            <div class="header-user" id="headerUser"></div>
        </div>
    </div>

    <div class="checkout-container">
        <!-- Main checkout flow -->
        <div class="checkout-main">
            
            <!-- Step 1: Authentication Choice -->
            <div class="checkout-section">
                <div class="section-title">
                    <span class="emoji">👤</span>
                    Account
                </div>
                
                <div class="auth-choice">
                    <label class="auth-option selected" data-auth="guest">
                        <input type="radio" name="authType" value="guest" checked>
                        <div class="auth-content">
                            <h3>🚀 Continue as Guest</h3>
                            <p>Quick checkout without creating an account</p>
                        </div>
                    </label>
                    
                    <label class="auth-option" data-auth="existing">
                        <input type="radio" name="authType" value="existing">
                        <div class="auth-content">
                            <h3>👤 I have an account</h3>
                            <p>Sign in to use saved details and view order history</p>
                        </div>
                    </label>
                    
                    <label class="auth-option" data-auth="register">
                        <input type="radio" name="authType" value="register">
                        <div class="auth-content">
                            <h3>✨ Create Account</h3>
                            <p>Save details for faster checkout next time</p>
                        </div>
                    </label>
                </div>

                <!-- Sign in form -->
                <div class="form-section" id="signinForm">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Email Address <span class="required">*</span></label>
                            <input type="email" id="signinEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Password <span class="required">*</span></label>
                            <input type="password" id="signinPassword" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="signinBtn">Sign In</button>
                </div>
            </div>

            <!-- Step 2: Contact Details -->
            <div class="checkout-section">
                <div class="section-title">
                    <span class="emoji">📧</span>
                    Contact Details
                </div>

                <div id="statusMessage"></div>

                <form id="checkoutForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name <span class="required">*</span></label>
                            <input type="text" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Address <span class="required">*</span></label>
                            <input type="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number <span class="required">*</span></label>
                            <input type="tel" name="phone" placeholder="07123 456789" required>
                        </div>
                    </div>

                    <!-- Registration password fields -->
                    <div class="form-row" id="passwordFields" style="display: none;">
                        <div class="form-group">
                            <label>Password <span class="required">*</span></label>
                            <input type="password" name="password" minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password <span class="required">*</span></label>
                            <input type="password" name="confirmPassword" minlength="6">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 3: Delivery Options -->
            <div class="checkout-section">
                <div class="section-title">
                    <span class="emoji">🚚</span>
                    Delivery Method
                </div>

                <div class="delivery-options">
                    <label class="delivery-option selected" data-delivery="delivery">
                        <input type="radio" name="deliveryType" value="delivery" checked>
                        <div>
                            <h4>🚚 Delivery</h4>
                            <p>Delivered to your address</p>
                        </div>
                    </label>
                    <label class="delivery-option" data-delivery="collection">
                        <input type="radio" name="deliveryType" value="collection">
                        <div>
                            <h4>🏪 Collection</h4>
                            <p>Pick up from restaurant</p>
                        </div>
                    </label>
                </div>

                <!-- Address form (shown for delivery) -->
                <div id="addressForm">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Street Address <span class="required">*</span></label>
                            <input type="text" name="streetAddress" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>City <span class="required">*</span></label>
                            <input type="text" name="city" value="York" required>
                        </div>
                        <div class="form-group">
                            <label>Postcode <span class="required">*</span></label>
                            <input type="text" name="postcode" placeholder="YO10 3BP" required>
                            <div class="postcode-status" id="postcodeStatus"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Delivery Instructions (Optional)</label>
                            <textarea name="deliveryInstructions" rows="3" placeholder="Ring doorbell, leave at door, etc."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Payment Method -->
            <div class="checkout-section">
                <div class="section-title">
                    <span class="emoji">💳</span>
                    Payment Method
                </div>

                <div class="payment-methods">
                    <label class="payment-method selected" data-payment="cash">
                        <input type="radio" name="paymentMethod" value="cash" checked>
                        <div>
                            <h4>💰 Cash on Delivery</h4>
                            <p>Pay when your order arrives</p>
                        </div>
                    </label>
                    <label class="payment-method" data-payment="card">
                        <input type="radio" name="paymentMethod" value="card">
                        <div>
                            <h4>💳 Card Payment</h4>
                            <p>Pay securely online</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Step 5: Final Review -->
            <div class="checkout-section">
                <div class="section-title">
                    <span class="emoji">📋</span>
                    Review Order
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Special Instructions (Optional)</label>
                        <textarea name="specialInstructions" rows="3" placeholder="Any special requests for your order..."></textarea>
                    </div>
                </div>

                <div class="terms-checkbox">
                    <input type="checkbox" id="termsAccepted" required>
                    <label for="termsAccepted">
                        I agree to the <a href="#" target="_blank">Terms and Conditions</a> and <a href="#" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <button type="button" class="btn btn-success" id="placeOrderBtn">
                    <span id="orderBtnText">Place Order</span>
                </button>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="order-sidebar">
            <div class="order-summary">
                <h3 style="margin-bottom: 20px;">Order Summary</h3>
                
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be populated here -->
                </div>

                <div class="order-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">£0.00</span>
                    </div>
                    <div class="total-row" id="deliveryFeeRow">
                        <span>Delivery Fee:</span>
                        <span id="deliveryFee">£0.00</span>
                    </div>
                    <div class="total-row" id="discountRow" style="display: none;">
                        <span>Discount:</span>
                        <span id="discount">-£0.00</span>
                    </div>
                    <div class="total-row final">
                        <span>Total:</span>
                        <span id="total">£0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        // Complete checkout manager
        class CompleteCheckoutManager {
            constructor() {
                this.currentUser = null;
                this.cartItems = this.loadCartItems();
                this.deliveryFee = 0;
                this.subtotal = 0;
                this.total = 0;
                this.apiBase = 'https://goldenfish-backend-production.up.railway.app/api';
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkAuthentication();
                this.setDeliveryTypeFromMenu(); // Set delivery type from menu selection
                this.updateOrderSummary();
                this.validatePostcode = this.debounce(this.validatePostcode.bind(this), 500);
            }
            
            setDeliveryTypeFromMenu() {
                // Set delivery type radio buttons based on menu selection
                if (this.deliveryType) {
                    const radioToSelect = this.deliveryType === 'delivery' ? 'delivery' : 'collection';
                    const radioBtn = document.querySelector(`input[name="deliveryType"][value="${radioToSelect}"]`);
                    if (radioBtn) {
                        radioBtn.checked = true;
                        console.log('📋 Set delivery type UI:', radioToSelect);
                    }
                }
                
                // Pre-fill postcode if available
                if (this.deliveryPostcode && this.deliveryType === 'delivery') {
                    const postcodeInput = document.getElementById('postcode');
                    if (postcodeInput) {
                        postcodeInput.value = this.deliveryPostcode;
                        console.log('📮 Pre-filled postcode:', this.deliveryPostcode);
                    }
                }
                
                // Trigger delivery type change to show/hide relevant sections
                this.handleDeliveryTypeChange();
            }

            setupEventListeners() {
                // Auth type selection
                document.querySelectorAll('input[name="authType"]').forEach(radio => {
                    radio.addEventListener('change', this.handleAuthTypeChange.bind(this));
                });

                // Delivery type selection
                document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                    radio.addEventListener('change', this.handleDeliveryTypeChange.bind(this));
                });

                // Payment method selection
                document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                    radio.addEventListener('change', this.handlePaymentMethodChange.bind(this));
                });

                // Auth option visual selection
                document.querySelectorAll('.auth-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.auth-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                });

                // Delivery option visual selection
                document.querySelectorAll('.delivery-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.delivery-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                });

                // Payment method visual selection
                document.querySelectorAll('.payment-method').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.payment-method').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                });

                // Postcode validation
                const postcodeInput = document.querySelector('input[name="postcode"]');
                if (postcodeInput) {
                    postcodeInput.addEventListener('input', (e) => {
                        this.validatePostcode(e.target.value);
                    });
                }

                // Sign in button
                document.getElementById('signinBtn').addEventListener('click', this.handleSignIn.bind(this));

                // Place order button
                document.getElementById('placeOrderBtn').addEventListener('click', this.handlePlaceOrder.bind(this));
            }

            loadCartItems() {
                console.log('🔍 Loading cart data from localStorage...');
                
                // First try to load from checkoutData (preferred - most complete)
                const checkoutData = localStorage.getItem('checkoutData');
                if (checkoutData) {
                    const data = JSON.parse(checkoutData);
                    console.log('📋 Loading from checkoutData:', data);
                    
                    // Set delivery information
                    if (data.delivery) {
                        this.deliveryType = data.delivery.type || 'delivery';
                        this.deliveryPostcode = data.delivery.postcode || '';
                        this.deliveryFee = parseFloat(data.delivery.fee) || 0;
                        this.selectedTime = data.delivery.selectedTime || '';
                        console.log('🚚 Delivery info loaded:', this.deliveryType, this.deliveryPostcode, this.deliveryFee);
                    }
                    
                    // Set totals if available
                    if (data.totals) {
                        this.subtotal = parseFloat(data.totals.subtotal) || 0;
                        this.total = parseFloat(data.totals.total) || 0;
                    }
                    
                    return data.items || [];
                }
                
                // Second try: goldenfish_cart (menu-system format)
                const cart = localStorage.getItem('goldenfish_cart');
                if (cart) {
                    console.log('📋 Loading from goldenfish_cart');
                    const items = JSON.parse(cart);
                    
                    // Load delivery info from separate keys
                    this.deliveryType = localStorage.getItem('deliveryType') || 'delivery';
                    this.deliveryPostcode = localStorage.getItem('postcode') || '';
                    this.deliveryFee = parseFloat(localStorage.getItem('deliveryFee')) || 0;
                    
                    return items;
                }
                
                // Third try: cartItems (legacy fallback)
                const cartItems = localStorage.getItem('cartItems');
                if (cartItems) {
                    console.log('📋 Loading from cartItems (legacy)');
                    const items = JSON.parse(cartItems);
                    
                    // Load delivery info from separate keys
                    this.deliveryType = localStorage.getItem('deliveryType') || 'delivery';
                    this.deliveryPostcode = localStorage.getItem('postcode') || '';
                    this.deliveryFee = parseFloat(localStorage.getItem('deliveryFee')) || 0;
                    
                    return items;
                }
                
                console.log('❌ No cart data found in localStorage');
                return [];
            }

            checkAuthentication() {
                const token = localStorage.getItem('auth_token');
                const userData = localStorage.getItem('user_data');
                
                if (token && userData) {
                    this.currentUser = JSON.parse(userData);
                    this.prefillUserData();
                    this.showUserInHeader();
                }
            }

            prefillUserData() {
                if (!this.currentUser) return;

                const form = document.getElementById('checkoutForm');
                form.firstName.value = this.currentUser.firstName || '';
                form.lastName.value = this.currentUser.lastName || '';
                form.email.value = this.currentUser.email || '';
                form.phone.value = this.currentUser.phone || '';
            }

            showUserInHeader() {
                const headerUser = document.getElementById('headerUser');
                if (this.currentUser) {
                    const initials = `${this.currentUser.firstName?.charAt(0) || ''}${this.currentUser.lastName?.charAt(0) || ''}`.toUpperCase();
                    headerUser.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 32px; height: 32px; background: #22c55e; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                                ${initials}
                            </div>
                            <span style="font-size: 14px; color: #6b7280;">${this.currentUser.email}</span>
                        </div>
                    `;
                }
            }

            handleAuthTypeChange(e) {
                const authType = e.target.value;
                const signinForm = document.getElementById('signinForm');
                const passwordFields = document.getElementById('passwordFields');

                // Hide all forms first
                signinForm.style.display = 'none';
                passwordFields.style.display = 'none';

                if (authType === 'existing') {
                    signinForm.style.display = 'block';
                } else if (authType === 'register') {
                    passwordFields.style.display = 'block';
                }
            }

            handleDeliveryTypeChange(e) {
                // Handle case where method is called without event (from setDeliveryTypeFromMenu)
                let deliveryType;
                if (e && e.target) {
                    deliveryType = e.target.value;
                } else {
                    // Get current delivery type from checked radio button
                    const checkedRadio = document.querySelector('input[name="deliveryMethod"]:checked');
                    deliveryType = checkedRadio ? checkedRadio.value : this.deliveryType;
                }
                
                const addressForm = document.getElementById('addressForm');
                const deliveryFeeRow = document.getElementById('deliveryFeeRow');
                
                if (deliveryType === 'delivery') {
                    addressForm.style.display = 'block';
                    deliveryFeeRow.style.display = 'flex';
                } else {
                    addressForm.style.display = 'none';
                    deliveryFeeRow.style.display = 'none';
                    this.deliveryFee = 0;
                }
                
                this.updateOrderSummary();
            }

            handlePaymentMethodChange(e) {
                // Handle payment method selection
                console.log('Payment method selected:', e.target.value);
            }

            async validatePostcode(postcode) {
                const status = document.getElementById('postcodeStatus');
                
                if (!postcode || postcode.length < 4) {
                    status.innerHTML = '';
                    this.deliveryFee = 0;
                    this.updateOrderSummary();
                    return;
                }

                try {
                    // Normalize postcode
                    const normalizedPostcode = this.normalizePostcode(postcode);
                    console.log('📮 Validating postcode:', postcode, '→', normalizedPostcode);
                    
                    // Check with postcodes.io API
                    const apiUrl = `https://api.postcodes.io/postcodes/${encodeURIComponent(normalizedPostcode)}`;
                    console.log('🌐 API call:', apiUrl);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        console.error('❌ Postcode API error:', response.status, response.statusText);
                        if (response.status === 404) {
                            throw new Error(`Postcode not found - please check and try again`);
                        } else {
                            throw new Error(`Postcode API error: ${response.status}`);
                        }
                    }
                    
                    const data = await response.json();

                    if (data.status === 200) {
                        // Valid postcode - calculate delivery fee
                        const fee = this.calculateDeliveryFee(normalizedPostcode);
                        if (fee.valid) {
                            status.innerHTML = `✅ ${fee.zone} - ${fee.display}`;
                            status.className = 'postcode-status valid';
                            this.deliveryFee = fee.amount;
                        } else {
                            status.innerHTML = `❌ ${fee.display}`;
                            status.className = 'postcode-status invalid';
                            this.deliveryFee = 0;
                        }
                    } else {
                        status.innerHTML = '❌ Invalid postcode';
                        status.className = 'postcode-status invalid';
                        this.deliveryFee = 0;
                    }
                } catch (error) {
                    status.innerHTML = '⚠️ Unable to validate postcode';
                    status.className = 'postcode-status invalid';
                    this.deliveryFee = 0;
                }

                this.updateOrderSummary();
            }

            normalizePostcode(postcode) {
                // Remove spaces and convert to uppercase
                const cleaned = postcode.replace(/\s/g, '').toUpperCase();
                // Add space before last 3 characters
                if (cleaned.length > 3) {
                    return cleaned.slice(0, -3) + ' ' + cleaned.slice(-3);
                }
                return cleaned;
            }

            calculateDeliveryFee(postcode) {
                // Delivery zones configuration (from script.js)
                const deliveryZones = [
                    { zone: 'YO10 3BP', fee: 2.50, display: '£2.50' },
                    { zone: 'YO10', fee: 3.00, display: '£3.00' },
                    { zone: 'YO1', fee: 3.50, display: '£3.50' },
                ];

                // Check exact match first
                for (const zone of deliveryZones) {
                    if (postcode === zone.zone) {
                        return {
                            valid: true,
                            amount: zone.fee,
                            display: zone.display,
                            zone: `Zone: ${zone.zone}`
                        };
                    }
                }

                // Check prefix match
                for (const zone of deliveryZones) {
                    if (postcode.startsWith(zone.zone) && zone.zone.length < postcode.length) {
                        return {
                            valid: true,
                            amount: zone.fee,
                            display: zone.display,
                            zone: `Zone: ${zone.zone} area`
                        };
                    }
                }

                return {
                    valid: false,
                    amount: 0,
                    display: 'Outside delivery area',
                    zone: 'Not available'
                };
            }

            updateOrderSummary() {
                const cartItemsEl = document.getElementById('cartItems');
                const subtotalEl = document.getElementById('subtotal');
                const deliveryFeeEl = document.getElementById('deliveryFee');
                const totalEl = document.getElementById('total');

                // Calculate subtotal
                console.log('🔍 Cart items for display:', this.cartItems);
                this.subtotal = this.cartItems.reduce((sum, item) => {
                    const quantity = item.qty || item.quantity || 1;
                    let itemPrice = item.price || 0;
                    if (item.selectedOptions) {
                        Object.entries(item.selectedOptions).forEach(([groupName, choice]) => {
                            if (Array.isArray(choice)) {
                                choice.forEach(c => itemPrice += c.price || 0);
                            } else {
                                itemPrice += choice.price || 0;
                            }
                        });
                    }
                    return sum + (itemPrice * quantity);
                }, 0);

                // Render cart items
                cartItemsEl.innerHTML = this.cartItems.map(item => {
                    const quantity = item.qty || item.quantity || 1;
                    let itemPrice = item.price || 0;
                    let optionsText = '';
                    
                    if (item.selectedOptions) {
                        const optionsList = [];
                        Object.entries(item.selectedOptions).forEach(([groupName, choice]) => {
                            if (Array.isArray(choice)) {
                                choice.forEach(c => {
                                    optionsList.push(c.name);
                                    itemPrice += c.price || 0;
                                });
                            } else {
                                optionsList.push(choice.name);
                                itemPrice += choice.price || 0;
                            }
                        });
                        optionsText = optionsList.join(', ');
                    }
                    
                    if (item.selectedVariant) {
                        optionsText = optionsText ? `${item.selectedVariant.name}, ${optionsText}` : item.selectedVariant.name;
                    }
                    
                    return `
                        <div class="cart-item">
                            <div class="item-details">
                                <h4>${item.name}</h4>
                                <div class="options">Qty: ${quantity}</div>
                                ${optionsText ? `<div class="options">${optionsText}</div>` : ''}
                            </div>
                            <div class="item-price">$${(itemPrice * quantity).toFixed(2)}</div>
                        </div>
                    `;
                }).join('');

                // Update totals
                this.total = this.subtotal + this.deliveryFee;
                
                subtotalEl.textContent = `$${this.subtotal.toFixed(2)}`;
                deliveryFeeEl.textContent = `$${this.deliveryFee.toFixed(2)}`;
                totalEl.textContent = `$${this.total.toFixed(2)}`;
                console.log('📊 Order summary updated:', { subtotal: this.subtotal, deliveryFee: this.deliveryFee, total: this.total });
            }

            async handleSignIn() {
                const email = document.getElementById('signinEmail').value.trim();
                const password = document.getElementById('signinPassword').value.trim();
                const btn = document.getElementById('signinBtn');
                
                if (!email || !password) {
                    this.showStatus('Please enter both email and password', 'error');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Signing In...';

                try {
                    const response = await fetch(`${this.apiBase}/auth/signin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.currentUser = result.data.user;
                        localStorage.setItem('auth_token', result.data.token);
                        localStorage.setItem('user_data', JSON.stringify(this.currentUser));
                        
                        this.prefillUserData();
                        this.showUserInHeader();
                        this.showStatus(`Welcome back, ${this.currentUser.firstName}!`, 'success');
                        
                        // Hide sign in form
                        document.getElementById('signinForm').style.display = 'none';
                        
                        // Select guest option to continue
                        document.querySelector('input[value="guest"]').checked = true;
                        document.querySelector('[data-auth="guest"]').classList.add('selected');
                        document.querySelector('[data-auth="existing"]').classList.remove('selected');
                    } else {
                        this.showStatus(result.message || 'Invalid email or password', 'error');
                    }
                } catch (error) {
                    console.error('Sign in error:', error);
                    this.showStatus('Unable to sign in. Please try again later.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Sign In';
                }
            }

            async handleUserRegistration() {
                const form = document.getElementById('checkoutForm');
                const email = form.email.value.trim();
                const password = form.password.value.trim();
                const confirmPassword = form.confirmPassword.value.trim();
                const firstName = form.firstName.value.trim();
                const lastName = form.lastName.value.trim();
                const phone = form.phone.value.trim();

                // Validate passwords match
                if (password !== confirmPassword) {
                    return {
                        success: false,
                        message: 'Passwords do not match'
                    };
                }

                // Validate password strength
                if (password.length < 6) {
                    return {
                        success: false,
                        message: 'Password must be at least 6 characters long'
                    };
                }

                try {
                    const response = await fetch(`${this.apiBase}/auth/signup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            firstName,
                            lastName,
                            email,
                            phone,
                            password
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Store user data and token
                        this.currentUser = result.data.user;
                        localStorage.setItem('auth_token', result.data.token);
                        localStorage.setItem('user_data', JSON.stringify(this.currentUser));
                        
                        // 预加载用户信息到表单
                        this.prefillUserData();
                        this.showUserInHeader();
                        this.showStatus(`Account created successfully! Welcome, ${this.currentUser.firstName}!`, 'success');
                        
                        // 隐藏注册表单，切换到guest模式继续结账
                        const passwordFields = document.getElementById('passwordFields');
                        if (passwordFields) passwordFields.style.display = 'none';
                        
                        // 切换到guest选项继续结账
                        const guestRadio = document.querySelector('input[value="guest"]');
                        if (guestRadio) guestRadio.checked = true;
                        const guestOption = document.querySelector('[data-auth="guest"]');
                        const registerOption = document.querySelector('[data-auth="register"]');
                        if (guestOption) guestOption.classList.add('selected');
                        if (registerOption) registerOption.classList.remove('selected');
                        
                        return { success: true };
                    } else {
                        return {
                            success: false,
                            message: result.message || 'Failed to create account'
                        };
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    return {
                        success: false,
                        message: 'Unable to create account. Please try again later.'
                    };
                }
            }

            async handlePlaceOrder() {
                if (!this.validateForm()) return;

                const orderBtn = document.getElementById('placeOrderBtn');
                const btnText = document.getElementById('orderBtnText');
                
                orderBtn.disabled = true;
                btnText.innerHTML = '<span class="spinner"></span> Placing Order...';

                try {
                    // Handle user registration if needed
                    const authType = document.querySelector('input[name="authType"]:checked').value;
                    if (authType === 'register') {
                        const registerResult = await this.handleUserRegistration();
                        if (!registerResult.success) {
                            this.showStatus(registerResult.message, 'error');
                            orderBtn.disabled = false;
                            btnText.textContent = 'Place Order';
                            return;
                        }
                    }

                    const orderData = this.collectOrderData();
                    
                    const response = await fetch(`${this.apiBase}/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Clear cart
                        localStorage.removeItem('goldenfish_cart');
                        
                        // Show success and redirect
                        this.showStatus('Order placed successfully!', 'success');
                        
                        setTimeout(() => {
                            window.location.href = `order-confirmation.html?orderNumber=${result.data.orderNumber}`;
                        }, 2000);
                    } else {
                        this.showStatus(result.error || 'Failed to place order', 'error');
                    }
                } catch (error) {
                    console.error('Order submission error:', error);
                    this.showStatus('Unable to place order. Please try again.', 'error');
                } finally {
                    orderBtn.disabled = false;
                    btnText.textContent = 'Place Order';
                }
            }

            validateForm() {
                const form = document.getElementById('checkoutForm');
                const termsAccepted = document.getElementById('termsAccepted').checked;
                
                // Check required fields
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        isValid = false;
                    } else {
                        field.classList.remove('error');
                    }
                });

                // Email validation
                const emailField = form.email;
                if (emailField && emailField.value.trim()) {
                    if (!this.isValidEmail(emailField.value.trim())) {
                        emailField.classList.add('error');
                        this.showStatus('Please enter a valid email address', 'error');
                        isValid = false;
                    } else {
                        emailField.classList.remove('error');
                    }
                }
                
                // UK phone number validation
                const phoneField = form.phone;
                if (phoneField && phoneField.value.trim()) {
                    const normalizedPhone = this.normalizeUKPhone(phoneField.value.trim());
                    if (!normalizedPhone) {
                        phoneField.classList.add('error');
                        this.showStatus('Please enter a valid UK mobile number (e.g. 07123 456789)', 'error');
                        isValid = false;
                    } else {
                        phoneField.classList.remove('error');
                        phoneField.value = normalizedPhone; // Update field with normalized format
                    }
                }

                // Check password validation for registration
                const authType = document.querySelector('input[name="authType"]:checked').value;
                if (authType === 'register') {
                    const password = form.password.value.trim();
                    const confirmPassword = form.confirmPassword.value.trim();
                    
                    if (password !== confirmPassword) {
                        form.confirmPassword.classList.add('error');
                        this.showStatus('Passwords do not match', 'error');
                        isValid = false;
                    }
                    
                    if (password.length < 6) {
                        form.password.classList.add('error');
                        this.showStatus('Password must be at least 6 characters long', 'error');
                        isValid = false;
                    }
                }

                // Check delivery address if delivery is selected
                const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
                if (deliveryType === 'delivery') {
                    const streetAddress = document.querySelector('input[name="streetAddress"]');
                    const postcode = document.querySelector('input[name="postcode"]');
                    
                    if (!streetAddress.value.trim()) {
                        streetAddress.classList.add('error');
                        isValid = false;
                    }
                    
                    if (!postcode.value.trim()) {
                        postcode.classList.add('error');
                        isValid = false;
                    }

                    // 企业级送餐费验证 - 使用专业API重新计算
                    if (this.deliveryFee === 0 && deliveryType === 'delivery') {
                        try {
                            // 调用企业级API重新验证送餐费
                            const response = await fetch('https://goldenfish-backend-production.up.railway.app/api/delivery/calculate-fee', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    restaurantId: 1,
                                    customerPostcode: postcode.value.trim(),
                                    orderValue: this.subtotal || 0
                                })
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                this.deliveryFee = result.data.deliveryFee;
                                this.updateOrderSummary();
                                this.showStatus(`Delivery fee verified: £${result.data.deliveryFee.toFixed(2)}`, 'success');
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            // Fallback to default fee if API fails
                            this.deliveryFee = 3.50;
                            this.updateOrderSummary();
                            this.showStatus('Using standard delivery fee £3.50', 'warning');
                        }
                    }
                }

                // Check terms acceptance
                if (!termsAccepted) {
                    this.showStatus('Please accept the terms and conditions', 'error');
                    return false;
                }

                if (!isValid) {
                    this.showStatus('Please fill in all required fields', 'error');
                    return false;
                }

                return true;
            }

            collectOrderData() {
                const form = document.getElementById('checkoutForm');
                const authType = document.querySelector('input[name="authType"]:checked').value;
                const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                const orderData = {
                    accountType: authType === 'guest' ? 'guest' : 'registered',
                    isLoggedIn: !!this.currentUser,
                    customer: {
                        firstName: form.firstName.value.trim(),
                        lastName: form.lastName.value.trim(),
                        email: form.email.value.trim(),
                        phone: form.phone.value.trim()
                    },
                    delivery: {
                        method: deliveryType // 直接使用原始值：'delivery' 或 'collection'
                    },
                    payment: {
                        method: paymentMethod
                    },
                    items: this.cartItems.map(item => ({
                        name: item.name,
                        price: parseFloat(item.price),
                        quantity: parseInt(item.qty || item.quantity || 1),
                        product_id: item.id || item.product_id,
                        unit_price: parseFloat(item.price),
                        total_price: parseFloat(item.price) * parseInt(item.qty || item.quantity || 1),
                        options: item.selectedOptions || null
                    })),
                    totals: {
                        subtotal: this.subtotal,
                        delivery: this.deliveryFee,
                        total: this.total
                    },
                    specialInstructions: document.querySelector('textarea[name="specialInstructions"]').value.trim()
                };

                // Add delivery address if delivery
                if (deliveryType === 'delivery') {
                    const streetAddressField = form.streetAddress || document.querySelector('input[name="streetAddress"]');
                    const cityField = form.city || document.querySelector('input[name="city"]');
                    const postcodeField = form.postcode || document.querySelector('input[name="postcode"]');
                    const instructionsField = document.querySelector('textarea[name="deliveryInstructions"]');
                    
                    orderData.delivery.address = streetAddressField ? streetAddressField.value.trim() : '';
                    orderData.delivery.city = cityField ? cityField.value.trim() : 'York';
                    orderData.delivery.postcode = postcodeField ? postcodeField.value.trim() : '';
                    orderData.delivery.instructions = instructionsField ? instructionsField.value.trim() : '';
                }

                return orderData;
            }
            
            isValidEmail(email) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailRegex.test(email);
            }
            
            normalizeUKPhone(phone) {
                // Remove all spaces, hyphens, and parentheses
                let cleaned = phone.replace(/[\s\-\(\)]/g, '');
                
                // Handle different UK mobile formats
                if (cleaned.startsWith('+447')) {
                    // +447xxxxxxxxx format
                    cleaned = '0' + cleaned.substring(3);
                } else if (cleaned.startsWith('447')) {
                    // 447xxxxxxxxx format (missing +)
                    cleaned = '0' + cleaned.substring(2);
                } else if (cleaned.startsWith('7') && cleaned.length === 10) {
                    // 7xxxxxxxxx format (missing 0)
                    cleaned = '0' + cleaned;
                }
                
                // Validate UK mobile format: 07xxxxxxxxx (11 digits total)
                // Also allow UK landline numbers: 01xxx or 02xxx
                const ukMobileRegex = /^07[0-9]{9}$/;
                const ukLandlineRegex = /^0[12][0-9]{8,9}$/;
                
                if (ukMobileRegex.test(cleaned)) {
                    // Format mobile as: 07xxx xxxxxx  
                    return cleaned.substring(0, 5) + ' ' + cleaned.substring(5);
                } else if (ukLandlineRegex.test(cleaned)) {
                    // Format landline as: 01xxx xxxxxx or 02x xxxx xxxx
                    if (cleaned.startsWith('02')) {
                        return cleaned.substring(0, 3) + ' ' + cleaned.substring(3, 7) + ' ' + cleaned.substring(7);
                    } else {
                        return cleaned.substring(0, 5) + ' ' + cleaned.substring(5);
                    }
                }
                
                console.log('Phone validation failed for:', cleaned, 'Length:', cleaned.length);
                return null; // Invalid format
            }

            showStatus(message, type) {
                const statusEl = document.getElementById('statusMessage');
                statusEl.className = `status-message status-${type}`;
                statusEl.textContent = message;
                
                // Scroll to message
                statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Clear after 5 seconds
                if (type !== 'error') {
                    setTimeout(() => {
                        statusEl.className = '';
                        statusEl.textContent = '';
                    }, 5000);
                }
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize checkout manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('goldenfish_cart')) {
                new CompleteCheckoutManager();
            } else {
                // No cart items, redirect to menu
                alert('Your cart is empty. Please add items before checkout.');
                window.location.href = 'menu.html';
            }
        });
    </script>
</body>
</html>