<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout – Golden Fish</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Comprehensive checkout styles */
      .checkout-main {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
      }
      
      .checkout-form {
        background: var(--light);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow);
        padding: 2rem;
      }
      
      .checkout-summary {
        background: var(--light);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow);
        padding: 2rem;
        height: fit-content;
        position: sticky;
        top: 100px;
      }
      
      .checkout-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
      }
      
      .checkout-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      
      .section-title {
        color: var(--primary);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .section-number {
        background: var(--primary);
        color: var(--light);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 600;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .required {
        color: var(--danger);
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--accent);
      }
      
      .delivery-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .delivery-option {
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }
      
      .delivery-option.selected {
        border-color: var(--primary);
        background: rgba(211, 47, 47, 0.1);
      }
      
      .delivery-option input[type="radio"] {
        display: none;
      }
      
      .option-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
      }
      
      .option-desc {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }
      
      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        padding: 0.5rem 0;
      }
      
      .item-details {
        flex: 1;
      }
      
      .item-name {
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .item-options {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
      }
      
      .item-price {
        font-weight: 600;
        color: var(--primary);
        min-width: 80px;
        text-align: right;
      }
      
      .summary-divider {
        border-bottom: 1px solid var(--border);
        margin: 1rem 0;
      }
      
      .total-row {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary);
        border-top: 2px solid var(--primary);
        padding-top: 1rem;
        margin-top: 1rem;
      }
      
      .place-order-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--success) 0%, #388e3c 100%);
        color: var(--light);
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        margin-top: 1rem;
      }
      
      .place-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }
      
      .place-order-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .error-message {
        color: var(--danger);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      
      .success-message {
        color: var(--success);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      
      .validation-message {
        font-size: 0.85rem;
        margin-top: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid var(--danger);
      }
      
      .validation-message.success {
        background: rgba(76, 175, 80, 0.1);
        border-color: var(--success);
        color: var(--success);
      }
      
      @media (max-width: 768px) {
        .checkout-main {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        
        .checkout-summary {
          position: static;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
        
        .delivery-options {
          grid-template-columns: 1fr;
        }
      }
      
      /* Account Options Styles */
      .account-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .account-option {
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .account-option:hover {
        border-color: var(--primary);
        background: rgba(211, 47, 47, 0.02);
      }
      
      .account-option.active {
        border-color: var(--primary);
        background: rgba(211, 47, 47, 0.05);
      }
      
      .option-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .option-header input[type="radio"] {
        margin-top: 0.25rem;
        width: 20px;
        height: 20px;
        accent-color: var(--primary);
      }
      
      .option-header label {
        flex: 1;
        cursor: pointer;
        margin: 0;
      }
      
      .option-title {
        display: block;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
      }
      
      .option-description {
        display: block;
        font-size: 0.9rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }
      
      .login-form,
      .register-form {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
      }
      
      .login-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
      }
      
      .login-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }
      
      .forgot-password {
        margin: 0;
        font-size: 0.9rem;
      }
      
      .forgot-password a {
        color: var(--primary);
        text-decoration: none;
      }
      
      .forgot-password a:hover {
        text-decoration: underline;
      }
      
      .form-help {
        display: block;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
      }
      
      .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        line-height: 1.4;
      }
      
      .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin: 0;
        accent-color: var(--primary);
      }
      
      /* Postcode input group styling */
      .postcode-input-group {
        display: flex;
        gap: 0.5rem;
      }
      
      .postcode-input-group input {
        flex: 1;
      }
      
      .validate-postcode-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }
      
      .validate-postcode-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }
      
      .validate-postcode-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      
      /* Enhanced delivery fee display */
      #deliveryFeeDisplay {
        margin-top: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      #deliveryFeeDisplay.valid {
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid var(--success);
        color: var(--success);
      }
      
      #deliveryFeeDisplay.invalid {
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid var(--danger);
        color: var(--danger);
      }
      
      #deliveryFeeDisplay.loading {
        background: rgba(33, 150, 243, 0.1);
        border: 1px solid #2196F3;
        color: #2196F3;
      }
      
      /* Enhanced order summary */
      .checkout-summary {
        background: var(--light);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow);
        padding: 2rem;
        height: fit-content;
        position: sticky;
        top: 100px;
        border: 1px solid var(--border);
      }
      
      .summary-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--primary);
      }
      
      .summary-header h3 {
        color: var(--primary);
        margin: 0;
        font-size: 1.25rem;
      }
      
      .summary-icon {
        color: var(--primary);
        font-size: 1.5rem;
      }
      
      /* Security badges */
      .security-badges {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
      }
      
      .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }
      
      .security-badge span {
        font-size: 1rem;
      }
      
      /* Free items and discounts styling */
      .free-item {
        background: rgba(76, 175, 80, 0.05);
        border-radius: 8px;
        padding: 0.5rem;
        margin: 0.25rem 0;
      }
      
      .free-badge {
        background: var(--success);
        color: white;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 0.5rem;
      }
      
      .discount-item {
        color: var(--success);
        font-weight: 600;
      }
      
      .discount-item span:last-child {
        color: var(--success);
      }
    </style>
  </head>
  <body>
    <header class="navbar">
      <div class="container nav-inner">
        <div class="logo">
          <img src="assets/fish_and_chips.jpg" alt="Golden Fish logo" />
          <span>Golden Fish</span>
        </div>
        <nav>
          <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="menu.html">Order Online</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#contact">Contact Us</a></li>
          </ul>
        </nav>
      </div>
    </header>
    
    <div class="checkout-main">
      <!-- Order Form -->
      <div class="checkout-form">
        <form id="checkoutForm">
          <!-- Delivery Method Section -->
          <div class="checkout-section">
            <h3 class="section-title">
              <span class="section-number">1</span>
              Delivery Method
            </h3>
            <div class="delivery-options">
              <div class="delivery-option" data-type="collection">
                <input type="radio" name="deliveryType" value="collection" id="collection" checked>
                <label for="collection">
                  <div class="option-title">Collection</div>
                  <div class="option-desc">Pick up from restaurant</div>
                </label>
              </div>
              <div class="delivery-option" data-type="delivery">
                <input type="radio" name="deliveryType" value="delivery" id="delivery">
                <label for="delivery">
                  <div class="option-title">Delivery</div>
                  <div class="option-desc">Delivered to your door</div>
                </label>
              </div>
            </div>
            
            <div id="deliveryAddressSection" style="display: none;">
              <div class="form-group">
                <label for="deliveryAddress">Delivery Address <span class="required">*</span></label>
                <textarea id="deliveryAddress" name="deliveryAddress" rows="3" placeholder="Enter your full delivery address"></textarea>
              </div>
              <div class="form-group">
                <label for="deliveryPostcode">Postcode <span class="required">*</span></label>
                <div class="postcode-input-group">
                  <input type="text" id="deliveryPostcode" name="deliveryPostcode" placeholder="e.g. YO10 3BP" maxlength="8">
                  <button type="button" id="validatePostcodeBtn" class="validate-postcode-btn">Verify</button>
                </div>
                <div id="deliveryFeeDisplay"></div>
                <small class="form-help">Enter complete UK postcode for delivery validation</small>
              </div>
              <div class="form-group">
                <label for="deliveryInstructions">Delivery Instructions</label>
                <input type="text" id="deliveryInstructions" name="deliveryInstructions" placeholder="e.g. Leave at door, Ring bell">
              </div>
            </div>
          </div>
          
          <!-- Account Options Section -->
          <div class="checkout-section">
            <h3 class="section-title">
              <span class="section-number">2</span>
              Account Options
            </h3>
            <div class="account-options">
              <div class="account-option guest-option active" data-option="guest">
                <div class="option-header">
                  <input type="radio" id="guestCheckout" name="accountType" value="guest" checked>
                  <label for="guestCheckout">
                    <span class="option-title">Guest Checkout</span>
                    <span class="option-description">Quick checkout without creating an account</span>
                  </label>
                </div>
              </div>
              
              <div class="account-option login-option" data-option="login">
                <div class="option-header">
                  <input type="radio" id="loginCheckout" name="accountType" value="login">
                  <label for="loginCheckout">
                    <span class="option-title">Sign In</span>
                    <span class="option-description">Already have an account? Sign in for faster checkout</span>
                  </label>
                </div>
                <div class="login-form" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="loginEmail">Email <span class="required">*</span></label>
                      <input type="email" id="loginEmail" name="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                      <label for="loginPassword">Password <span class="required">*</span></label>
                      <input type="password" id="loginPassword" name="loginPassword" placeholder="Your password">
                    </div>
                  </div>
                  <button type="button" class="login-btn" id="signInBtn">Sign In</button>
                  <p class="forgot-password"><a href="#" onclick="alert('Password reset functionality coming soon!')">Forgot your password?</a></p>
                </div>
              </div>
              
              <div class="account-option register-option" data-option="register">
                <div class="option-header">
                  <input type="radio" id="registerCheckout" name="accountType" value="register">
                  <label for="registerCheckout">
                    <span class="option-title">Create Account</span>
                    <span class="option-description">Create an account to save your details and track orders</span>
                  </label>
                </div>
                <div class="register-form" style="display: none;">
                  <div class="form-group">
                    <label for="registerPassword">Create Password <span class="required">*</span></label>
                    <input type="password" id="registerPassword" name="registerPassword" placeholder="Create a secure password" minlength="8">
                    <small class="form-help">Password must be at least 8 characters long</small>
                  </div>
                  <div class="form-group">
                    <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password">
                  </div>
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" id="marketingOptIn" name="marketingOptIn">
                      <span class="checkmark"></span>
                      Send me promotional offers and updates (optional)
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Customer Information Section -->
          <div class="checkout-section">
            <h3 class="section-title">
              <span class="section-number">3</span>
              Contact Information
            </h3>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" name="email" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone Number <span class="required">*</span></label>
                <input type="tel" id="phone" name="phone" placeholder="e.g. 01904 123456, 07700 900123" required>
              </div>
            </div>
          </div>
          
          <!-- Order Timing Section -->
          <div class="checkout-section">
            <h3 class="section-title">
              <span class="section-number">4</span>
              Order Timing
            </h3>
            <div class="form-group">
              <label for="orderTime">Preferred Time</label>
              <select id="orderTime" name="orderTime">
                <option value="asap">As soon as possible</option>
              </select>
            </div>
            <div class="form-group">
              <label for="orderNotes">Special Requests</label>
              <textarea id="orderNotes" name="orderNotes" rows="3" placeholder="Any special requests or allergy information..."></textarea>
            </div>
          </div>
          
          <!-- Payment Method Section -->
          <div class="checkout-section">
            <h3 class="section-title">
              <span class="section-number">5</span>
              Payment Method
            </h3>
            <div class="form-group">
              <select id="paymentMethod" name="paymentMethod">
                <option value="card">Credit/Debit Card</option>
                <option value="paypal">PayPal</option>
                <option value="cash">Cash on Collection/Delivery</option>
              </select>
            </div>
            <div id="cardPaymentInfo" style="display: none;">
              <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                You will be redirected to our secure payment processor to complete your payment.
              </p>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Order Summary -->
      <div class="checkout-summary">
        <div class="summary-header">
          <span class="summary-icon">📋</span>
          <h3>Order Summary</h3>
        </div>
        <div id="orderSummary"></div>
        <div id="orderMessages"></div>
        <button id="placeOrderBtn" class="place-order-btn" type="button">Place Order</button>
        
        <!-- Security badges -->
        <div class="security-badges">
          <div class="security-badge">
            <span>🔒</span>
            <small>Secure Payment</small>
          </div>
          <div class="security-badge">
            <span>✅</span>
            <small>Order Protection</small>
          </div>
        </div>
      </div>
    </div>
    <script src="script.js"></script>
    <script>
      // Enhanced checkout functionality
      class CheckoutManager {
        constructor() {
          this.cart = JSON.parse(localStorage.getItem('goldenfish_cart') || '[]');
          this.deliveryFee = null;
          this.orderData = {};
          
          console.log('CheckoutManager initialized with cart:', this.cart);
          
          // Load order data from localStorage (delivery type, postcode, etc)
          this.loadOrderData();
          this.init();
        }
        
        loadOrderData() {
          // Load delivery type from menu page
          const orderType = localStorage.getItem('goldenfish_order_type') || 'collection';
          const savedPostcode = localStorage.getItem('goldenfish_postcode');
          const savedDeliveryFee = localStorage.getItem('goldenfish_delivery_fee');
          
          console.log('Loading order data:', { orderType, savedPostcode, savedDeliveryFee });
          
          // Set delivery type and update visual states
          const deliveryRadio = document.querySelector(`input[name="deliveryType"][value="${orderType}"]`);
          if (deliveryRadio) {
            deliveryRadio.checked = true;
            
            // Update delivery option visual styles
            this.updateDeliveryOptionStyles();
            
            console.log('Set delivery type to:', orderType, 'Radio checked:', deliveryRadio.checked);
          }
          
          // Set address input if delivery
          if (orderType === 'delivery') {
            const addressSection = document.getElementById('deliveryAddressSection');
            if (addressSection) {
              addressSection.style.display = 'block';
            }
            
            // Set postcode if available
            if (savedPostcode) {
              const postcodeInput = document.getElementById('deliveryPostcode');
              if (postcodeInput) {
                postcodeInput.value = savedPostcode;
              }
            }
          }
          
          // Restore delivery fee if available
          if (savedDeliveryFee) {
            try {
              this.deliveryFee = JSON.parse(savedDeliveryFee);
            } catch (error) {
              console.error('Error parsing saved delivery fee:', error);
            }
          }
        },
        
        init() {
          this.setupEventListeners();
          this.updateDeliveryOptions();
          this.populateOrderTimes();
          
          // Trigger delivery type change to show/hide address section
          this.handleDeliveryTypeChange();
          
          // Render order summary after setting up delivery options
          this.renderOrderSummary();
          
          // Calculate delivery fee if postcode is already entered
          const postcodeInput = document.getElementById('deliveryPostcode');
          if (postcodeInput && postcodeInput.value.trim()) {
            this.calculateDeliveryFee();
          }
        }
        
        setupEventListeners() {
          // Delivery method selection
          document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
            radio.addEventListener('change', () => this.handleDeliveryTypeChange());
          });
          
          // Delivery option styling
          document.querySelectorAll('.delivery-option').forEach(option => {
            option.addEventListener('click', () => {
              const radio = option.querySelector('input[type="radio"]');
              radio.checked = true;
              this.updateDeliveryOptionStyles();
              this.handleDeliveryTypeChange();
            });
          });
          
          // Postcode input for delivery fee calculation
          const postcodeInput = document.getElementById('deliveryPostcode');
          if (postcodeInput) {
            postcodeInput.addEventListener('input', () => {
              // Only auto-validate if it looks like a complete postcode
              const postcode = postcodeInput.value.trim();
              if (postcode.length >= 6 && postcode.includes(' ')) {
                this.calculateDeliveryFee();
              }
            });
          }
          
          // Validate postcode button
          const validateBtn = document.getElementById('validatePostcodeBtn');
          if (validateBtn) {
            validateBtn.addEventListener('click', () => this.calculateDeliveryFee());
          }
          
          // Real-time phone validation
          const phoneInput = document.getElementById('phone');
          if (phoneInput) {
            phoneInput.addEventListener('input', () => this.validatePhoneRealTime());
          }
          
          // Real-time email validation
          const emailInput = document.getElementById('email');
          if (emailInput) {
            emailInput.addEventListener('input', () => this.validateEmailRealTime());
          }
          
          // Payment method selection
          document.getElementById('paymentMethod').addEventListener('change', () => {
            this.updatePaymentInfo();
          });
          
          // Place order button
          document.getElementById('placeOrderBtn').addEventListener('click', () => {
            this.placeOrder();
          });
          
          // Account type selection
          document.querySelectorAll('input[name="accountType"]').forEach(radio => {
            radio.addEventListener('change', () => this.handleAccountTypeChange());
          });
          
          // Account option clicking
          document.querySelectorAll('.account-option').forEach(option => {
            option.addEventListener('click', (e) => {
              if (e.target.type !== 'radio' && e.target.type !== 'checkbox' && 
                  e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && 
                  e.target.tagName !== 'A') {
                const radio = option.querySelector('input[type="radio"]');
                if (radio) {
                  radio.checked = true;
                  this.handleAccountTypeChange();
                }
              }
            });
          });
          
          // Sign in button
          const signInBtn = document.getElementById('signInBtn');
          if (signInBtn) {
            signInBtn.addEventListener('click', () => this.handleSignIn());
          }
        }
        
        updateDeliveryOptionStyles() {
          document.querySelectorAll('.delivery-option').forEach(option => {
            const radio = option.querySelector('input[type="radio"]');
            if (radio.checked) {
              option.classList.add('selected');
            } else {
              option.classList.remove('selected');
            }
          });
        }
        
        handleDeliveryTypeChange() {
          const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
          const addressSection = document.getElementById('deliveryAddressSection');
          
          if (deliveryType === 'delivery') {
            addressSection.style.display = 'block';
            this.calculateDeliveryFee();
          } else {
            addressSection.style.display = 'none';
            this.deliveryFee = null;
          }
          
          this.updateDeliveryOptionStyles();
          this.renderOrderSummary();
        }
        
        async calculateDeliveryFee() {
          const rawPostcode = document.getElementById('deliveryPostcode').value.trim();
          const feeDisplay = document.getElementById('deliveryFeeDisplay');
          
          if (!rawPostcode) {
            feeDisplay.innerHTML = '';
            feeDisplay.className = '';
            this.deliveryFee = null;
            this.renderOrderSummary();
            return;
          }
          
          // Normalize and validate UK postcode format
          const normalizedPostcode = this.normalizeUKPostcode(rawPostcode);
          if (!normalizedPostcode || !this.isValidUKPostcodeFormat(rawPostcode)) {
            feeDisplay.innerHTML = '⚠️ Invalid postcode format. Please enter a complete UK postcode (e.g. YO10 3BP)';
            feeDisplay.className = 'invalid';
            this.deliveryFee = { valid: false, display: 'Invalid postcode format', zone: '', fee: null };
            this.renderOrderSummary();
            return;
          }
          
          // Update input field with normalized postcode
          const postcodeInput = document.getElementById('deliveryPostcode');
          if (postcodeInput && postcodeInput.value !== normalizedPostcode) {
            postcodeInput.value = normalizedPostcode;
          }
          
          try {
            feeDisplay.innerHTML = '🔄 Validating postcode...';
            feeDisplay.className = 'loading';
            
            // Validate postcode exists using free API
            const isValidPostcode = await this.validateUKPostcode(normalizedPostcode);
            
            if (!isValidPostcode) {
              feeDisplay.innerHTML = '❌ Invalid UK postcode. Please check and try again.';
              feeDisplay.className = 'invalid';
              this.deliveryFee = { valid: false, display: 'Invalid postcode', zone: '', fee: null };
              this.renderOrderSummary();
              return;
            }
            
            // Calculate delivery fee
            const feeResult = await calcDeliveryFee(normalizedPostcode);
            
            if (feeResult.valid) {
              feeDisplay.innerHTML = `
                ✅ ${feeResult.display}
                <br><small>${feeResult.zone}</small>
              `;
              feeDisplay.className = 'valid';
              this.deliveryFee = feeResult;
            } else {
              feeDisplay.innerHTML = `
                ⚠️ ${feeResult.display}
                <br><small>${feeResult.zone}</small>
              `;
              feeDisplay.className = 'invalid';
              this.deliveryFee = feeResult;
            }
            
            this.renderOrderSummary();
          } catch (error) {
            console.error('Error calculating delivery fee:', error);
            feeDisplay.innerHTML = '❌ Error validating postcode. Please try again.';
            feeDisplay.className = 'invalid';
            this.deliveryFee = { valid: false, display: 'Validation error', zone: '', fee: null };
            this.renderOrderSummary();
          }
        }
        
        updateDeliveryOptions() {
          this.updateDeliveryOptionStyles();
        }
        
        populateOrderTimes() {
          // This would integrate with the existing time selection logic
          const orderTime = document.getElementById('orderTime');
          // For now, keep ASAP option
        }
        
        updatePaymentInfo() {
          const paymentMethod = document.getElementById('paymentMethod').value;
          const cardInfo = document.getElementById('cardPaymentInfo');
          
          if (paymentMethod === 'card' || paymentMethod === 'paypal') {
            cardInfo.style.display = 'block';
          } else {
            cardInfo.style.display = 'none';
          }
        }
        
        renderOrderSummary() {
          const orderSummary = document.getElementById('orderSummary');
          
          if (this.cart.length === 0) {
            orderSummary.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Your cart is empty!</p>';
            document.getElementById('placeOrderBtn').disabled = true;
            return;
          }
          
          let subtotal = 0;
          let html = '';
          
          // Separate regular items from free items
          const regularItems = this.cart.filter(item => !item.isFreeItem);
          const freeItems = this.cart.filter(item => item.isFreeItem);
          
          // Render regular cart items
          regularItems.forEach(item => {
            let itemTotal = item.price;
            
            // Add option prices
            if (item.selectedOptions) {
              Object.values(item.selectedOptions).forEach(option => {
                if (Array.isArray(option)) {
                  option.forEach(opt => itemTotal += opt.price || 0);
                } else {
                  itemTotal += option.price || 0;
                }
              });
            }
            
            const lineTotal = itemTotal * item.qty;
            subtotal += lineTotal;
            
            // Build options text
            let optionsText = '';
            if (item.selectedOptions && Object.keys(item.selectedOptions).length > 0) {
              optionsText = Object.entries(item.selectedOptions)
                .map(([group, choice]) => {
                  if (Array.isArray(choice)) {
                    return choice.map(c => c.name).join(', ');
                  }
                  return choice.name;
                })
                .join(' • ');
            }
            
            html += `
              <div class="summary-item">
                <div class="item-details">
                  <div class="item-name">${item.name} x${item.qty}</div>
                  ${optionsText ? `<div class="item-options">${optionsText}</div>` : ''}
                </div>
                <div class="item-price">£${lineTotal.toFixed(2)}</div>
              </div>
            `;
          });
          
          // Add free items if any
          if (freeItems.length > 0) {
            freeItems.forEach(item => {
              html += `
                <div class="summary-item free-item">
                  <div class="item-details">
                    <div class="item-name">${item.name} x${item.qty} <span class="free-badge">FREE</span></div>
                  </div>
                  <div class="item-price">£0.00</div>
                </div>
              `;
            });
          }
          
          html += '<div class="summary-divider"></div>';
          html += `<div class="summary-item"><span>Subtotal:</span><span>£${subtotal.toFixed(2)}</span></div>`;
          
          // Calculate and display promotions (if any saved)
          const savedPromotions = localStorage.getItem('goldenfish_applied_promotions');
          let totalDiscount = 0;
          
          if (savedPromotions) {
            try {
              const promotions = JSON.parse(savedPromotions);
              promotions.forEach(promo => {
                if (promo.type === 'amount_off' && promo.discountAmount > 0) {
                  html += `
                    <div class="summary-item discount-item">
                      <span>Discount: ${promo.name}</span>
                      <span>-£${promo.discountAmount.toFixed(2)}</span>
                    </div>
                  `;
                  totalDiscount += promo.discountAmount;
                } else if (promo.type === 'percentage_off' && promo.discountAmount > 0) {
                  html += `
                    <div class="summary-item discount-item">
                      <span>Discount: ${promo.name}</span>
                      <span>-£${promo.discountAmount.toFixed(2)}</span>
                    </div>
                  `;
                  totalDiscount += promo.discountAmount;
                }
              });
            } catch (error) {
              console.error('Error parsing saved promotions:', error);
            }
          }
          
          // Add delivery fee if applicable
          let total = subtotal - totalDiscount;
          if (this.deliveryFee && this.deliveryFee.valid && this.deliveryFee.fee !== null) {
            html += `<div class="summary-item"><span>Delivery (${this.deliveryFee.zone}):</span><span>${this.deliveryFee.display}</span></div>`;
            total += this.deliveryFee.fee;
          }
          
          html += `<div class="summary-item total-row"><span>Total:</span><span>£${Math.max(0, total).toFixed(2)}</span></div>`;
          
          orderSummary.innerHTML = html;
          
          // Enable/disable order button based on delivery validity
          const placeOrderBtn = document.getElementById('placeOrderBtn');
          if (this.deliveryFee && !this.deliveryFee.valid) {
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = this.deliveryFee.display;
          } else {
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = `Place Order - £${Math.max(0, total).toFixed(2)}`;
          }
        }
        
        validateForm() {
          const form = document.getElementById('checkoutForm');
          const formData = new FormData(form);
          const errors = [];
          
          // Required fields validation
          const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
          requiredFields.forEach(field => {
            if (!formData.get(field)?.trim()) {
              errors.push(`${field.replace(/([A-Z])/g, ' $1').toLowerCase()} is required`);
            }
          });
          
          // Email validation
          const email = formData.get('email')?.trim();
          if (email && !this.validateEmail(email)) {
            errors.push('Please enter a valid email address');
          }
          
          // UK phone validation
          const phone = formData.get('phone')?.trim();
          if (phone && !this.validateUKPhone(phone)) {
            errors.push('Please enter a valid UK phone number (e.g., 01904 123456, 07700 900123, +44 1904 123456)');
          }
          
          // Delivery address validation
          const deliveryType = formData.get('deliveryType');
          if (deliveryType === 'delivery') {
            if (!formData.get('deliveryAddress')?.trim()) {
              errors.push('Delivery address is required');
            }
            if (!formData.get('deliveryPostcode')?.trim()) {
              errors.push('Delivery postcode is required');
            }
            if (this.deliveryFee && !this.deliveryFee.valid) {
              errors.push('Delivery is not available to this postcode');
            }
          }
          
          return errors;
        }
        
        // Email validation helper
        validateEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        }
        
        // UK phone validation helper
        validateUKPhone(phone) {
          if (!phone) return false;
          
          // Remove all spaces, hyphens, parentheses, and dots
          const cleanPhone = phone.replace(/[\s\-\(\)\.]/g, '');
          
          // UK phone number patterns
          const patterns = [
            // UK mobile numbers (07xxx xxxxxx) - with or without +44
            /^(\+44|0044|44)?7\d{9}$/,
            
            // UK landline numbers (01xxx xxxxxx, 02xxx xxxxxx) - with or without +44
            /^(\+44|0044|44)?[12]\d{9,10}$/,
            
            // UK landline numbers (03xxx xxxxxx) - with or without +44
            /^(\+44|0044|44)?3\d{9}$/,
            
            // UK special numbers (08xxx xxxxxx, 09xxx xxxxxx) - with or without +44
            /^(\+44|0044|44)?[89]\d{9}$/,
            
            // Standard UK landline without country code (starting with 0)
            /^0[1-9]\d{8,9}$/,
            
            // Standard UK mobile without country code (07xxx xxxxxx)
            /^07\d{9}$/
          ];
          
          return patterns.some(pattern => pattern.test(cleanPhone));
        },
        
        // UK postcode normalization and validation
        normalizeUKPostcode(postcode) {
          if (!postcode) return '';
          
          // Remove all spaces and convert to uppercase
          let cleaned = postcode.trim().toUpperCase().replace(/\s/g, '');
          
          // Must be at least 5 characters (minimum: M11AA)
          if (cleaned.length < 5 || cleaned.length > 7) {
            return null; // Invalid length
          }
          
          // Insert space before last 3 characters
          const formatted = cleaned.slice(0, -3) + ' ' + cleaned.slice(-3);
          
          return formatted;
        },
        
        // UK postcode format validation
        isValidUKPostcodeFormat(postcode) {
          const normalized = this.normalizeUKPostcode(postcode);
          if (!normalized) return false;
          
          // UK postcode regex
          const ukPostcodeRegex = /^[A-Z]{1,2}[0-9][A-Z0-9]?\s[0-9][A-Z]{2}$/i;
          
          return ukPostcodeRegex.test(normalized);
        },
        
        // Validate UK postcode using free API
        async validateUKPostcode(postcode) {
          try {
            // Using postcodes.io free API
            const response = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`);
            const data = await response.json();
            return response.ok && data.status === 200;
          } catch (error) {
            console.error('Error validating postcode:', error);
            // Fallback to format validation if API fails
            return this.isValidUKPostcodeFormat(postcode);
          }
        }
        
        // Real-time phone validation
        validatePhoneRealTime() {
          const phoneInput = document.getElementById('phone');
          const phone = phoneInput.value.trim();
          
          // Remove any existing validation messages
          const existingMessage = phoneInput.nextElementSibling;
          if (existingMessage && existingMessage.classList.contains('validation-message')) {
            existingMessage.remove();
          }
          
          if (phone && !this.validateUKPhone(phone)) {
            phoneInput.style.borderColor = 'var(--danger)';
            const errorMessage = document.createElement('div');
            errorMessage.className = 'validation-message error-message';
            errorMessage.textContent = 'Please enter a valid UK phone number';
            phoneInput.parentNode.appendChild(errorMessage);
          } else {
            phoneInput.style.borderColor = phone ? 'var(--success)' : 'var(--border)';
          }
        }
        
        // Real-time email validation
        validateEmailRealTime() {
          const emailInput = document.getElementById('email');
          const email = emailInput.value.trim();
          
          // Remove any existing validation messages
          const existingMessage = emailInput.nextElementSibling;
          if (existingMessage && existingMessage.classList.contains('validation-message')) {
            existingMessage.remove();
          }
          
          if (email && !this.validateEmail(email)) {
            emailInput.style.borderColor = 'var(--danger)';
            const errorMessage = document.createElement('div');
            errorMessage.className = 'validation-message error-message';
            errorMessage.textContent = 'Please enter a valid email address';
            emailInput.parentNode.appendChild(errorMessage);
          } else {
            emailInput.style.borderColor = email ? 'var(--success)' : 'var(--border)';
          }
        }
        
        async placeOrder() {
          // Check if this is an advance order and show warning if needed
          const checkoutBtn = document.getElementById('placeOrderBtn');
          const isAdvanceOrder = checkoutBtn && checkoutBtn.getAttribute('data-advance-order') === 'true';
          
          if (isAdvanceOrder && config.advanceOrdering.showWarningMessage) {
            const confirmed = await this.showAdvanceOrderWarning();
            if (!confirmed) {
              return; // User cancelled advance order
            }
          }
          
          const errors = this.validateForm();
          const messagesDiv = document.getElementById('orderMessages');
          
          if (errors.length > 0) {
            messagesDiv.innerHTML = `
              <div class="error-message">
                <strong>Please fix the following errors:</strong><br>
                ${errors.map(error => `• ${error}`).join('<br>')}
              </div>
            `;
            return;
          }
          
          // Collect form data
          const form = document.getElementById('checkoutForm');
          const formData = new FormData(form);
          
          const orderData = {
            customer: {
              firstName: formData.get('firstName'),
              lastName: formData.get('lastName'),
              email: formData.get('email'),
              phone: formData.get('phone')
            },
            delivery: {
              type: formData.get('deliveryType'),
              address: formData.get('deliveryAddress'),
              postcode: formData.get('deliveryPostcode'),
              instructions: formData.get('deliveryInstructions'),
              fee: this.deliveryFee
            },
            timing: {
              preferred: formData.get('orderTime'),
              notes: formData.get('orderNotes')
            },
            payment: {
              method: formData.get('paymentMethod')
            },
            items: this.cart,
            timestamp: new Date().toISOString(),
            orderNumber: 'GF' + Date.now().toString().slice(-6)
          };
          
          try {
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing Order...';
            
            // Here you would send the order to your backend
            console.log('Order data:', orderData);
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Clear cart
            localStorage.removeItem('goldenfish_cart');
            
            // Show success message
            messagesDiv.innerHTML = `
              <div class="success-message">
                <strong>Order placed successfully!</strong><br>
                Order number: ${orderData.orderNumber}<br>
                You will receive a confirmation email shortly.
              </div>
            `;
            
            // Redirect after delay
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 3000);
            
          } catch (error) {
            console.error('Error placing order:', error);
            messagesDiv.innerHTML = `
              <div class="error-message">
                <strong>Error placing order.</strong><br>
                Please try again or contact us directly.
              </div>
            `;
            
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = 'Place Order';
          }
        }
        
        // Show advance order warning dialog
        showAdvanceOrderWarning() {
          return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.zIndex = '2000';
            modal.innerHTML = `
              <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header" style="background: var(--warning); color: white;">
                  <h3>${config.advanceOrdering.warningMessage.title}</h3>
                  <button class="close-btn" type="button">&times;</button>
                </div>
                <div class="modal-body">
                  <p style="margin-bottom: 1rem; line-height: 1.6;">${config.advanceOrdering.warningMessage.content}</p>
                  <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="cancel-advance-btn" style="padding: 0.75rem 1.5rem; background: var(--gray); border: none; border-radius: 4px; cursor: pointer;">
                      ${config.advanceOrdering.warningMessage.cancelText}
                    </button>
                    <button class="confirm-advance-btn" style="padding: 0.75rem 1.5rem; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                      ${config.advanceOrdering.warningMessage.confirmText}
                    </button>
                  </div>
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle confirm
            modal.querySelector('.confirm-advance-btn').addEventListener('click', () => {
              document.body.removeChild(modal);
              resolve(true);
            });
            
            // Handle cancel
            const cancelHandler = () => {
              document.body.removeChild(modal);
              resolve(false);
            };
            
            modal.querySelector('.cancel-advance-btn').addEventListener('click', cancelHandler);
            modal.querySelector('.close-btn').addEventListener('click', cancelHandler);
            
            // Click outside to cancel
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                cancelHandler();
              }
            });
          });
        }
        
        // Handle account type change
        handleAccountTypeChange() {
          const selectedType = document.querySelector('input[name="accountType"]:checked')?.value;
          
          // Update active states
          document.querySelectorAll('.account-option').forEach(option => {
            option.classList.remove('active');
          });
          
          const activeOption = document.querySelector(`[data-option="${selectedType}"]`);
          if (activeOption) {
            activeOption.classList.add('active');
          }
          
          // Show/hide forms
          document.querySelectorAll('.login-form, .register-form').forEach(form => {
            form.style.display = 'none';
          });
          
          if (selectedType === 'login') {
            const loginForm = document.querySelector('.login-form');
            if (loginForm) loginForm.style.display = 'block';
          } else if (selectedType === 'register') {
            const registerForm = document.querySelector('.register-form');
            if (registerForm) registerForm.style.display = 'block';
          }
        }
        
        // Handle sign in
        async handleSignIn() {
          const email = document.getElementById('loginEmail')?.value.trim();
          const password = document.getElementById('loginPassword')?.value;
          
          if (!email || !password) {
            alert('Please enter both email and password.');
            return;
          }
          
          if (!this.validateEmail(email)) {
            alert('Please enter a valid email address.');
            return;
          }
          
          const signInBtn = document.getElementById('signInBtn');
          const originalText = signInBtn.textContent;
          
          try {
            signInBtn.textContent = 'Signing in...';
            signInBtn.disabled = true;
            
            // Simulate API call - replace with real authentication
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // For demo purposes, show success message
            alert('Sign in functionality will be implemented in the backend phase. For now, continue as guest.');
            
            // Reset to guest checkout
            document.getElementById('guestCheckout').checked = true;
            this.handleAccountTypeChange();
            
          } catch (error) {
            console.error('Sign in error:', error);
            alert('Sign in failed. Please try again or continue as guest.');
          } finally {
            signInBtn.textContent = originalText;
            signInBtn.disabled = false;
          }
        }
      }
      
      // Initialize checkout when page loads
      document.addEventListener('DOMContentLoaded', () => {
        new CheckoutManager();
      });
    </script>
  </body>
</html>