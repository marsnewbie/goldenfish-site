<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Cart - Golden Fish</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .debug-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .cart-display {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>购物车调试工具</h1>
    
    <div class="debug-section">
        <h2>当前LocalStorage状态</h2>
        <div id="localStorageStatus"></div>
        <button class="test-button" onclick="checkLocalStorage()">检查LocalStorage</button>
        <button class="test-button" onclick="clearCart()">清空购物车</button>
    </div>
    
    <div class="debug-section">
        <h2>测试添加商品到购物车</h2>
        <button class="test-button" onclick="addTestItem()">添加测试商品</button>
        <button class="test-button" onclick="addComplexItem()">添加带选项商品</button>
        <div id="cartDisplay" class="cart-display"></div>
    </div>
    
    <div class="debug-section">
        <h2>测试Checkout流程</h2>
        <button class="test-button" onclick="testCheckout()">测试Checkout</button>
        <div id="checkoutResult"></div>
    </div>
    
    <div class="debug-section">
        <h2>控制台日志</h2>
        <div id="consoleLog" style="background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // 重写console.log来显示在页面上
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.getElementById('consoleLog');
            if (logDiv) {
                logDiv.innerHTML += args.join(' ') + '<br>';
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        };

        // 初始化购物车
        let cart = JSON.parse(localStorage.getItem('goldenfish_cart') || '[]');
        
        function checkLocalStorage() {
            const statusDiv = document.getElementById('localStorageStatus');
            const cartData = localStorage.getItem('goldenfish_cart');
            const orderType = localStorage.getItem('goldenfish_order_type');
            const postcode = localStorage.getItem('goldenfish_postcode');
            
            statusDiv.innerHTML = `
                <div><strong>购物车数据:</strong> ${cartData || '无'}</div>
                <div><strong>订单类型:</strong> ${orderType || '无'}</div>
                <div><strong>邮编:</strong> ${postcode || '无'}</div>
                <div><strong>购物车长度:</strong> ${cart.length}</div>
            `;
            
            console.log('🔍 LocalStorage检查:');
            console.log('Cart:', cartData);
            console.log('Order type:', orderType);
            console.log('Postcode:', postcode);
            
            updateCartDisplay();
        }
        
        function clearCart() {
            localStorage.removeItem('goldenfish_cart');
            localStorage.removeItem('goldenfish_order_type');
            localStorage.removeItem('goldenfish_postcode');
            cart = [];
            console.log('🗑️ 购物车已清空');
            checkLocalStorage();
        }
        
        function addTestItem() {
            const testItem = {
                id: 'test1',
                name: 'Test Special Curry',
                price: 12.80,
                qty: 1
            };
            
            cart.push(testItem);
            localStorage.setItem('goldenfish_cart', JSON.stringify(cart));
            console.log('✅ 添加测试商品:', testItem);
            checkLocalStorage();
        }
        
        function addComplexItem() {
            const complexItem = {
                id: 'test2',
                name: 'Complex Duck Dish',
                price: 21.00,
                qty: 1,
                selectedVariant: { name: 'Half', price: 21.00 },
                selectedOptions: {
                    'Choose Sauce': { name: 'Plum Sauce', price: 0 },
                    'Extra Additions': [
                        { name: 'Extra Meat', price: 3.50 },
                        { name: 'Prawn Crackers', price: 1.50 }
                    ]
                }
            };
            
            cart.push(complexItem);
            localStorage.setItem('goldenfish_cart', JSON.stringify(cart));
            console.log('✅ 添加复杂商品:', complexItem);
            checkLocalStorage();
        }
        
        function updateCartDisplay() {
            const displayDiv = document.getElementById('cartDisplay');
            if (cart.length === 0) {
                displayDiv.innerHTML = '<div class="error">购物车为空</div>';
                return;
            }
            
            let html = '<div class="success">购物车内容:</div>';
            let total = 0;
            
            cart.forEach((item, index) => {
                let itemTotal = item.price * item.qty;
                
                // 计算选项价格
                if (item.selectedOptions) {
                    Object.entries(item.selectedOptions).forEach(([groupName, choice]) => {
                        if (Array.isArray(choice)) {
                            choice.forEach(c => itemTotal += c.price * item.qty);
                        } else {
                            itemTotal += choice.price * item.qty;
                        }
                    });
                }
                
                total += itemTotal;
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                        <strong>${item.name}</strong> x${item.qty} - $${itemTotal.toFixed(2)}
                        ${item.selectedVariant ? `<br>Size: ${item.selectedVariant.name}` : ''}
                        ${item.selectedOptions ? `<br>Options: ${JSON.stringify(item.selectedOptions)}` : ''}
                    </div>
                `;
            });
            
            html += `<div style="font-weight: bold; margin-top: 10px;">总计: $${total.toFixed(2)}</div>`;
            displayDiv.innerHTML = html;
        }
        
        function testCheckout() {
            const resultDiv = document.getElementById('checkoutResult');
            
            console.log('🔄 测试Checkout流程');
            console.log('Cart length:', cart.length);
            console.log('Cart contents:', cart);
            
            if (cart.length === 0) {
                resultDiv.innerHTML = '<div class="error">购物车为空，无法checkout</div>';
                console.log('❌ 购物车为空');
                return;
            }
            
            // 模拟checkout流程
            localStorage.setItem('goldenfish_order_type', 'delivery');
            localStorage.setItem('goldenfish_postcode', 'YO10 3BP');
            
            console.log('✅ Checkout数据已保存');
            console.log('- Order type: delivery');
            console.log('- Postcode: YO10 3BP');
            
            resultDiv.innerHTML = `
                <div class="success">Checkout测试成功!</div>
                <div>购物车商品数: ${cart.length}</div>
                <div>订单类型: delivery</div>
                <div>邮编: YO10 3BP</div>
                <div><a href="checkout.html" target="_blank">点击测试Checkout页面</a></div>
            `;
        }
        
        // 页面加载时检查状态
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>